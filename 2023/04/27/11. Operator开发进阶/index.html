<!DOCTYPE html>
<html lang="en">

<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
	
	<!-- title -->
	
	<title>
	
		Operator开发进阶 | 
	 
	倪克松的博客
	</title>
	
	<!-- keywords,description -->
	 

	<!-- favicon -->
	
	<link rel="shortcut icon" href="/favicon.ico">
	


	<!-- search -->
	<script>
		var searchEngine = "https://www.google.com/search?q=";
		if(typeof searchEngine == "undefined" || searchEngine == null || searchEngine == ""){
			searchEngine = "https://www.google.com/search?q=";
		}
		var homeHost = "";
		if(typeof homeHost == "undefined" || homeHost == null || homeHost == ""){
			homeHost = window.location.host;
		}
	</script>


	
<link rel="stylesheet" href="/css/main.css">

	
<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css">

	
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.17.1/build/styles/darcula.min.css">

	
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">


	
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>

	
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>

	
<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.17.1/build/highlight.min.js"></script>

	
<script src="https://cdn.jsdelivr.net/npm/jquery-pjax@2.0.1/jquery.pjax.min.js"></script>

	
<script src="/js/main.js"></script>


	
		
<script src="https://cdn.jsdelivr.net/npm/leancloud-storage/dist/av-min.js"></script>

		
<script src="https://cdn.jsdelivr.net/npm/valine@v1.5.1/dist/Valine.min.js"></script>

	
	

<meta name="generator" content="Hexo 6.3.0"></head>

<body>
	<header id="header">
    <a id="title" href="/" class="logo">倪克松的博客</a>

	<ul id="menu">
    

    

    

    
      
      
        <li class="menu-item">
          <a href='https://github.com/NikeSong' class="menu-item-link" target="_blank">
            Nicolson
          </a>
        </li>
      
    
  
    
      <li class="menu-item">
        <a href='https://github.com/NikeSong' class="menu-item-link" target="_blank">
          <i class="fa fa-github fa-2x"></i>
        </a>
      </li>
    
	</ul>
</header>

	
<div id="sidebar">
	<button id="sidebar-toggle" class="toggle" ><i class="fa fa-arrow-right " aria-hidden="true"></i></button>
	
	<div id="site-toc">
		<input id="search-input" class="search-input" type="search" placeholder="按回车全站搜索">
		<div id="tree">
			

			
							<ul>
								<li class="file">
									<a href="/2023/04/23/1.%20Kubernetes%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/">
                     
										    Kubernetes基本结构
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/04/28/10.%20%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Client-go%E5%AE%9E%E7%8E%B0%E6%9C%BA%E7%90%86/">
                     
										    Client-Go学习与实战
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file active">
									<a href="/2023/04/27/11.%20Operator%E5%BC%80%E5%8F%91%E8%BF%9B%E9%98%B6/">
                     
										    Operator开发进阶
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/05/01/12.%20Java%20Client%20Library/">
                     
										    Java Client Library
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/05/01/13.%20Java%E6%96%B0%E5%BB%BAOperator/">
                     
										    Java新建Operator
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/04/23/2.%20Pod%E7%BB%86%E8%8A%82%E5%88%86%E6%9E%90/">
                     
										    Pod细节分析
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/04/24/3.%20K8s%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2/">
                     
										    K8s服务暴露
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/04/24/4.%20%E6%8E%A2%E7%A7%98Docker%E5%AE%B9%E5%99%A8%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/">
                     
										    探秘Docker容器的实现原理（进行中）
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/04/25/5.%20%E4%BB%80%E4%B9%88%E6%98%AFOperator/">
                     
										    什么是Operator
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/04/25/6.%20%E5%B0%9D%E8%AF%95%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84Pod%E7%AE%A1%E7%90%86%E6%8E%A7%E5%88%B6%E5%99%A8/">
                     
										    尝试开发一个简单的Pod管理控制器
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/04/26/7.%20%E3%80%90%E6%95%85%E9%9A%9C%E3%80%91K8s%E7%BB%84%E4%BB%B6%E7%89%88%E6%9C%AC%E5%87%BA%E9%97%AE%E9%A2%98/">
                     
										    【故障】K8s组件版本出问题
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/04/27/7.5.%20%E3%80%90%E6%95%85%E9%9A%9C%E3%80%91%E4%B8%80%E5%8F%B0%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%99%BB%E9%99%86%E4%B8%8D%E8%BF%9B%E5%8E%BB%E4%BA%86/">
                     
										    【故障】一台虚拟机登陆不进去了
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/04/27/8.%20k8s%20api%E5%AD%A6%E4%B9%A0/">
                     
										    curl方式和raw方式访问api server
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/04/28/9.%20GVK-%E7%BB%84%E3%80%81%E7%89%88%E6%9C%AC%E5%92%8C%E7%B1%BB%E5%9E%8B/">
                     
										    GVK和GVR
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
		</div>
	</div>
</div>

	<!-- 引入正文 -->
	<div id="content">
		<h1 id="article-title">
	Operator开发进阶
</h1>

<!-- meta -->
<div class="article-meta">
	

	<span>倪克松</span>
	<span>2023-04-27 21:47:16</span>

  <div id="article-categories">
    
		  <span>Categories：</span>
      
          
              <span>
                  <i class="fa fa-folder" aria-hidden="true">
                  <a href="/categories/Kubernetes学习笔记/">Kubernetes学习笔记</a>
                  </i>
                
              </span>
          
      
    

    
		    <span>Tags：</span>
        
    
  </div>

</div>

<!-- content -->
<div id="article-content">
	<p>先复习一下上次的简单实验的流程</p>
<p><img src="/images/summarize_helloworld.png" alt=""></p>
<p>make manifests后并没有做什么操作，只是对文件进行了观察。所以</p>
<ul>
<li><strong>CRD的配置全都是在application_types.go中完成的</strong>。</li>
<li><strong>CR的配置也都是在config\ samples\ apps_v2_application.yaml中完成的</strong>。</li>
<li><strong>controller的设置全都是在controllers/ application_controller.go文件中完成的</strong>。</li>
</ul>
<p>简单的回顾后开始这次更加复杂的实验：</p>
<p>一般我们需要将一个应用部署到Kubernetes中时，都会选择用Deployment来管理应用，用Service来做服务发现，进一步可能还需要配置ConfigMap、Ingress、Secret等资源。这么多类型资源的创建、维护、管理工作会变得烦琐且复杂。</p>
<blockquote>
<p>**总结：**部署在K8s中的应用：</p>
<ul>
<li>Deployment等controler做管理</li>
<li>Service做服务发现</li>
<li>ConfigMap做配置存储</li>
<li>Ingress解决暴露多个Service的需求。</li>
<li>Secret存储敏感信息</li>
</ul>
</blockquote>
<p>我们可以通过Operator在一个应用部署所需的各种资源之上抽象一个Application类型，这个类型里包含必要的一些字段，然后用户只需要创建一个Application，我们通过自定义控制器去完成Application相关的Deployment、Service、ConfigMap等资源的创建和管理工作。</p>
<h3 id="1-初始化项目">1. 初始化项目</h3>
<p>初始化。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@master MyOPeratorProjects<span class="token punctuation">]</span><span class="token comment"># mkdir application-operator2</span>
<span class="token punctuation">[</span>root@master MyOPeratorProjects<span class="token punctuation">]</span><span class="token comment"># cd application-operator2</span>
<span class="token punctuation">[</span>root@master application-operator2<span class="token punctuation">]</span><span class="token comment"># ls</span>
<span class="token punctuation">[</span>root@master application-operator2<span class="token punctuation">]</span><span class="token comment"># kubebuilder init --domain=danielhu.cn --repo=github.com/daniel-hutao/application-operator --owner Daniel.Hu</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>项目名默认是application-operator，项目名和文件夹名字一致。这里需要知道的是项目名体现在哪些地方，若要修改项目名找到这些配置项调整即可：<br>
1）PROJECT文件中的projectName配置。<br>
2）config/default/kustomization.yaml文件中的namespace配置。<br>
3）config/default/kustomization.yaml文件中的namePrefix配置。</p>
<p><strong>这次更深入的看看项目的基础结构</strong></p>
<ul>
<li>go.mod：包含了项目的基础依赖。</li>
<li>Makefile：存放的是和开发过程中构建、部署、测试等相关的一系列命令。</li>
<li>PROJECT：存放的是一些Kubebuilder需要用到的元数据。</li>
<li>部署配置：还有很多与Operator部署相关的配置文件保存在config目录下，主要是运行Controller相关的Kustomize配置以及各种资源配置。</li>
<li>main.go：
<ul>
<li>文件中首先是注释内容，我们之前提到过每个源文件开头的Copyright声明来自hack/boilerplate.go.txt文件，并且这里会自动加上在kubebuilder init命令中使用–owner=Daniel Hu所指定的作者签名。</li>
<li>接下来是import部分。<a target="_blank" rel="noopener" href="http://xn--sigs-zh5fpp39nwtzzyhvvq3if533clu1ctts4vg.k8s.io/controller-runtime%E4%BE%9D%E8%B5%96%E5%8C%85%EF%BC%8C%E5%85%B6%E4%BB%96%E5%8C%85%E5%9C%A8%E5%90%8E%E9%9D%A2%E4%BD%BF%E7%94%A8%E7%9A%84%E6%97%B6%E5%80%99%E5%86%8D%E6%9D%A5%E5%85%B7%E4%BD%93%E7%9C%8B%E5%85%B6%E4%BD%9C%E7%94%A8%E3%80%82">这里主要是导入了核心的sigs.k8s.io/controller-runtime依赖包，其他包在后面使用的时候再来具体看其作用。</a></li>
<li>剩下的逻辑：
<ul>
<li>在main()函数中先设置了一些与metrics相关的标志（flags）</li>
<li>实例化了一个Manager对象，Manager负责跟踪维护和运行所有的Controllers</li>
<li>同时也设置了共享缓存以及和kube-apiserver通信用的各种Clients</li>
<li>在main()函数中通过Start()方法启动了Manager，Manager运行后反过来会启动所有Controller和Webhook。</li>
<li>这个Manager会一直运行在后台，直到接收到“优雅停止”信号。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="2-定义Application资源">2. 定义Application资源</h3>
<h4 id="2-1-API结构分析">2.1 API结构分析</h4>
<p>和第一次实验一样，这里我们需要创建<strong>Application类型和其对应的控制器</strong>，其命令是kubebuilder create api：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@master application-operator2<span class="token punctuation">]</span><span class="token comment"># kubebuilder create api --group apps --version v1 --kind Application</span>
Create Resource <span class="token punctuation">[</span>y/n<span class="token punctuation">]</span>
y
Create Controller <span class="token punctuation">[</span>y/n<span class="token punctuation">]</span>
y<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时项目路径有一次出现了 api / vi</p>
<p><strong>分析</strong></p>
<p>对于一个新的group-version，也就是组和版本都相同的一个资源类型，kubebuilder create api命令会新建一个目录来存放这个group-version。<a target="_blank" rel="noopener" href="http://xn--apps-4m5f5hu47f1man1pb4bux9jduwc.danielhu.cn/v1%E8%BF%99%E4%B8%AAgroup-version%E3%80%82%E8%BF%98%E8%AE%B0%E5%BE%97%E6%88%91%E4%BB%AC%E7%94%A8%E7%9A%84%E5%8F%82%E6%95%B0--group">该目录也就对应了apps.danielhu.cn/v1这个group-version。还记得我们用的参数--group</a> apps吗？group名会自动加上一开始新建项目时使用–domain所指定的danielhu.cn域名，<a target="_blank" rel="noopener" href="http://xn--apps-4m5f5htxz03ar1sqnn7oa.danielhu.cn">所以也就变成了apps.danielhu.cn</a>。</p>
<p>打开<strong>application_types.go文件</strong>，有关Copyright部分就不用说了，import部分可以看到只有简单的一行依赖：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">import</span> <span class="token punctuation">(</span>
	metav1 <span class="token string">"k8s.io/apimachinery/pkg/apis/meta/v1"</span>
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>后面接着是Application类型对应的Spec和Status结构体定义：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// ApplicationSpec defines the desired state of Application</span>
<span class="token keyword">type</span> ApplicationSpec <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// INSERT ADDITIONAL SPEC FIELDS - desired state of cluster</span>
	<span class="token comment">// Important: Run "make" to regenerate code after modifying this file</span>

	<span class="token comment">// Foo is an example field of Application. Edit application_types.go to remove/update</span>
	Foo <span class="token builtin">string</span> <span class="token string">`json:"foo,omitempty"`</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// ApplicationStatus defines the observed state of Application</span>
<span class="token keyword">type</span> ApplicationStatus <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// INSERT ADDITIONAL STATUS FIELD - define observed state of cluster</span>
	<span class="token comment">// Important: Run "make" to regenerate code after modifying this file</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们知道Operator的核心逻辑就是不断调谐资源对象的实际状态和期望状态（Spec）保持一致。这里的Status当然不是严格对应“实际状态”，而是观察并记录下来的当前对象最新“状态”。大多数资源对象都有Spec和Status两个部分，但是也有部分资源对象不符合这种模式，比如ConfigMap之类的静态资源对象就不存在着“期望的状态”这一说法。</p>
<p>继续往下可以看到对应Application类型的结构体定义：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// Application is the Schema for the applications API</span>
<span class="token keyword">type</span> Application <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	metav1<span class="token punctuation">.</span>TypeMeta   <span class="token string">`json:",inline"`</span>
	metav1<span class="token punctuation">.</span>ObjectMeta <span class="token string">`json:"metadata,omitempty"`</span>

	Spec   ApplicationSpec   <span class="token string">`json:"spec,omitempty"`</span>
	Status ApplicationStatus <span class="token string">`json:"status,omitempty"`</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//+kubebuilder:object:root=true</span>

<span class="token comment">// ApplicationList contains a list of Application</span>
<span class="token keyword">type</span> ApplicationList <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	metav1<span class="token punctuation">.</span>TypeMeta <span class="token string">`json:",inline"`</span>
	metav1<span class="token punctuation">.</span>ListMeta <span class="token string">`json:"metadata,omitempty"`</span>
	Items           <span class="token punctuation">[</span><span class="token punctuation">]</span>Application <span class="token string">`json:"items"`</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>Application结构体是Application类型的“根类型”</strong>，和其他所有的Kubernetes资源类型一样包含TypeMeta和ObjectMeta。TypeMeta中存放的是当前资源的Kind和APIVersion信息，ObjectMeta中存放的是Name、Namespace、Labels和Annotations等信息。<br>
而<strong>ApplicationList其实只是简单的一个Application集合类型</strong>，其中通过Items存放一组Application，用于List之类的批量操作。<br>
一般情况下，这两个对象都是不需要修改的，<strong>我们修改的是前面提到的ApplicationSpec和ApplicationStatus两个结构体</strong>。<br>
另外，我们还看到上面的代码中有一行//+kubebuilder:object:root=true这样的特殊注释标记。这个标记主要是被controller-tools识别，然后controller-tools的对象生成器就知道这个标记下面的对象代表一个Kind，接着对象生成器会生成相应的Kind需要的代码，也就是实现runtime.Object接口。换言之，一个结构体要表示一个Kind，必须实现runtime.Object接口。</p>
<p>最后还有一个init()函数：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	SchemeBuilder<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Application<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>ApplicationList<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="2-2-自定义新API">2.2 自定义新API</h4>
<p>接下来定义自己的API，将Application改成需要的样子。如下所示，<strong>在ApplicationSpec中添加Deployment和Service属性，类型分别为DeploymentTemplate和ServiceTemplate</strong>：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// ApplicationSpec defines the desired state of Application</span>
<span class="token keyword">type</span> ApplicationSpec <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	Deployment DeploymentTemplate <span class="token string">`json:"deployment,omitempty"`</span>
	Service    ServiceTemplate    <span class="token string">`json:"service,omitempty"`</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>下一步是<strong>定义DeploymentTemplate和ServiceTemplate</strong>。在这里我们简单地引用Kubernetes原生的DeploymentSpec对象和ServiceSpec对象来构造DeploymentTemplate和ServiceTemplate。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> DeploymentTemplate <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	appsv1<span class="token punctuation">.</span>DeploymentSpec <span class="token string">`json:",inline"`</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">type</span> ServiceTemplate <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	corev1<span class="token punctuation">.</span>ServiceSpec <span class="token string">`json:",inline"`</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>接着是状态的定义。当然，这里不需要太复杂的逻辑，同样是简单地引用Kubernetes原生的DeploymentStatus对象和ServiceStatus对象来实现状态管理逻辑。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// ApplicationStatus defines the observed state of Application</span>
<span class="token keyword">type</span> ApplicationStatus <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	Workflow appsv1<span class="token punctuation">.</span>DeploymentStatus <span class="token string">`json:"workflow"`</span>
	Network  corev1<span class="token punctuation">.</span>ServiceStatus    <span class="token string">`json:"network"`</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="3-实现Application-Controller">3. 实现Application Controller</h3>
<h4 id="3-1-实现主调谐流程">3.1 实现主调谐流程</h4>
<p>Application资源定义好之后，当然就要开始写控制器的核心调谐逻辑了。打开controllers/application_controller.go源文件，我们可以看到Reconcile方法的骨架。接下来要实现的调谐逻辑大致如下所示。我们先查看代码，然后<strong>对照流程图中的步骤来详细解释</strong>：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>ApplicationReconciler<span class="token punctuation">)</span> <span class="token function">Reconcile</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req ctrl<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">(</span>ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token operator">&lt;-</span>time<span class="token punctuation">.</span><span class="token function">NewTicker</span><span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span><span class="token punctuation">.</span>C
	log <span class="token operator">:=</span> log<span class="token punctuation">.</span><span class="token function">FromContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>

	CounterReconcileApplication <span class="token operator">+=</span> <span class="token number">1</span>
	log<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"Starting a reconcile"</span><span class="token punctuation">,</span> <span class="token string">"number"</span><span class="token punctuation">,</span> CounterReconcileApplication<span class="token punctuation">)</span>

	app <span class="token operator">:=</span> <span class="token operator">&amp;</span>dappsv1<span class="token punctuation">.</span>Application<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> req<span class="token punctuation">.</span>NamespacedName<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> errors<span class="token punctuation">.</span><span class="token function">IsNotFound</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			log<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"Application not found."</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
		<span class="token punctuation">&#125;</span>
		log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"Failed to get the Application, will requeue after a short time."</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">&#123;</span>RequeueAfter<span class="token punctuation">:</span> GenericRequeueDuration<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> err
	<span class="token punctuation">&#125;</span>

	<span class="token comment">// reconcile sub-resources</span>
	<span class="token keyword">var</span> result ctrl<span class="token punctuation">.</span>Result
	<span class="token keyword">var</span> err <span class="token builtin">error</span>

	result<span class="token punctuation">,</span> err <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">reconcileDeployment</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> app<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"Failed to reconcile Deployment."</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> result<span class="token punctuation">,</span> err
	<span class="token punctuation">&#125;</span>

	result<span class="token punctuation">,</span> err <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">reconcileService</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> app<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"Failed to reconcile Service."</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> result<span class="token punctuation">,</span> err
	<span class="token punctuation">&#125;</span>

	log<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"All resources have been reconciled."</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/images/tiao_xie.png" alt="tiao_xie"></p>
<h5 id="3-1-1-计数器">3.1.1 计数器</h5>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token operator">&lt;-</span>time<span class="token punctuation">.</span><span class="token function">NewTicker</span><span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span><span class="token punctuation">.</span>C
log <span class="token operator">:=</span> log<span class="token punctuation">.</span><span class="token function">FromContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>

CounterReconcileApplication <span class="token operator">+=</span> <span class="token number">1</span>
log<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"Starting a reconcile"</span><span class="token punctuation">,</span> <span class="token string">"number"</span><span class="token punctuation">,</span> CounterReconcileApplication<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>由于调谐过程是并发执行的，也就是说，如果同时创建3个Application类型的资源实例，这时3个事件会同时被处理，日志会比较混乱，所以我们在开头加了一个100毫秒的等待，同时在后面加了一个计数器CounterReconcileApplication，并打印一条日志来输出当前是第几轮调谐。这里不用担心这个数字会溢出，大家如果感兴趣可以计算一下int64有多大，是不是能够让这个程序运行100年也不用担心这里的计数器溢出。CounterReconcileApplication的声明是：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">var</span> CounterReconcileApplication <span class="token builtin">int64</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h5 id="3-1-2-查询对应的Application">3.1.2 查询对应的Application</h5>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">app <span class="token operator">:=</span> <span class="token operator">&amp;</span>dappsv1<span class="token punctuation">.</span>Application<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> req<span class="token punctuation">.</span>NamespacedName<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> errors<span class="token punctuation">.</span><span class="token function">IsNotFound</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"Application not found."</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>
	log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"Failed to get the Application, will requeue after a short time."</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">&#123;</span>RequeueAfter<span class="token punctuation">:</span> GenericRequeueDuration<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> err
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里先实例化了一个*v1.Application类型的app对象，然后通过r.Get()方法查询触发当前调谐逻辑对应的Application，将其写入app。<br>
接着我们需要处理err != nil的情况，错误分为两种：Application不存在与其他错误。如果是Application不存在，我们的处理是打印一条日志，然后直接返回ctrl.Result{},nil，也就是意味着“本轮调谐结束”。因为不管是出于什么原因导致Application不存在，比如是被删除了，这时控制器不管进行什么处理都是没有意义的。如果之后不久Application又被创建出来，那么这个调谐过程会被再次触发。所以当前调谐过程只需要直接退出就行了。除此以外的错误，我们需要通过重试来处理，所以除了错误日志打印外，还需要返回ctrl.Result{RequeueAfter:GenericRequeueDuration},err，也就是在1分钟后再次触发本函数调谐。这里的GenericRequeueDuration定义在文件开头：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">const</span> GenericRequeueDuration <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Minute<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h5 id="3-1-3-调谐Deployment">3.1.3 调谐Deployment</h5>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// reconcile sub-resources</span>
<span class="token keyword">var</span> result ctrl<span class="token punctuation">.</span>Result
<span class="token keyword">var</span> err <span class="token builtin">error</span>

result<span class="token punctuation">,</span> err <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">reconcileDeployment</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> app<span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
	log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"Failed to reconcile Deployment."</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> result<span class="token punctuation">,</span> err
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里将主要逻辑封装到reconcileDeployment()方法中去实现，从而让主调谐函数看起来可读性更好。当然，reconcileDeployment()方法要做的事情就是完成Deployment资源的调谐过程，然后返回对应的result和error，对于主调谐函数Reconcile()来说，只需要在reconcileDeployment()方法返回的error不等于nil的时候直接返回这个result和error即可。</p>
<h5 id="3-1-4-调谐Service">3.1.4 调谐Service</h5>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">result<span class="token punctuation">,</span> err <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">reconcileService</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> app<span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
	log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"Failed to reconcile Service."</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> result<span class="token punctuation">,</span> err
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Service的调谐方式和Deployment基本是一样的，我们同样封装到一个名为reconcileService()的方法中。上面的Deployment调谐过程如果没有任何错误，代码逻辑就会继续走到Service的调谐，最后如果Service的调谐过程没有任何错误，那么主调谐函数的任务就算完成了。所以最后的逻辑是：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">log<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"All resources have been reconciled."</span><span class="token punctuation">)</span>
<span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="3-2-实现Deployment调谐流程">3.2 实现Deployment调谐流程</h4>
<p>在实现控制器的主调谐逻辑时，我们留了两个待实现的子调谐逻辑，也就是reconcileDeployment()方法和reconcileService()方法。接下来，自然是需要实现这两个方法了，我们先从reconcileDeployment()方法开始。<br>
在controllers目录下，与application_controller.go源文件同级目录内创建一个deployment.go源文件来实现Deployment的调谐逻辑。<br>
我们要实现的Deployment调谐逻辑大致如下图所示。</p>
<p><img src="/images/deployment_reconcile.png" alt="deployment_reconcile"></p>
<p>同样先查看代码，然后对照流程图中的步骤来详细分析：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>ApplicationReconciler<span class="token punctuation">)</span> <span class="token function">reconcileDeployment</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> app <span class="token operator">*</span>dappsv1<span class="token punctuation">.</span>Application<span class="token punctuation">)</span> <span class="token punctuation">(</span>ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	log <span class="token operator">:=</span> log<span class="token punctuation">.</span><span class="token function">FromContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>

	<span class="token keyword">var</span> dp <span class="token operator">=</span> <span class="token operator">&amp;</span>appsv1<span class="token punctuation">.</span>Deployment<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
	err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> types<span class="token punctuation">.</span>NamespacedName<span class="token punctuation">&#123;</span>
		Namespace<span class="token punctuation">:</span> app<span class="token punctuation">.</span>Namespace<span class="token punctuation">,</span>
		Name<span class="token punctuation">:</span>      app<span class="token punctuation">.</span>Name<span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> dp<span class="token punctuation">)</span>

	<span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"The Deployment has already exist."</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> reflect<span class="token punctuation">.</span><span class="token function">DeepEqual</span><span class="token punctuation">(</span>dp<span class="token punctuation">.</span>Status<span class="token punctuation">,</span> app<span class="token punctuation">.</span>Status<span class="token punctuation">.</span>Workflow<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
		<span class="token punctuation">&#125;</span>

		app<span class="token punctuation">.</span>Status<span class="token punctuation">.</span>Workflow <span class="token operator">=</span> dp<span class="token punctuation">.</span>Status
		<span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"Failed to update Application status"</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">&#123;</span>RequeueAfter<span class="token punctuation">:</span> GenericRequeueDuration<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> err
		<span class="token punctuation">&#125;</span>
		log<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"The Application status has been updated."</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> <span class="token operator">!</span>errors<span class="token punctuation">.</span><span class="token function">IsNotFound</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"Failed to get Deployment, will requeue after a short time."</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">&#123;</span>RequeueAfter<span class="token punctuation">:</span> GenericRequeueDuration<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> err
	<span class="token punctuation">&#125;</span>

	newDp <span class="token operator">:=</span> <span class="token operator">&amp;</span>appsv1<span class="token punctuation">.</span>Deployment<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
	newDp<span class="token punctuation">.</span><span class="token function">SetName</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
	newDp<span class="token punctuation">.</span><span class="token function">SetNamespace</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>Namespace<span class="token punctuation">)</span>
	newDp<span class="token punctuation">.</span><span class="token function">SetLabels</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>Labels<span class="token punctuation">)</span>
	newDp<span class="token punctuation">.</span>Spec <span class="token operator">=</span> app<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Deployment<span class="token punctuation">.</span>DeploymentSpec
	newDp<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Template<span class="token punctuation">.</span><span class="token function">SetLabels</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>Labels<span class="token punctuation">)</span>

	<span class="token keyword">if</span> err <span class="token operator">:=</span> ctrl<span class="token punctuation">.</span><span class="token function">SetControllerReference</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> newDp<span class="token punctuation">,</span> r<span class="token punctuation">.</span>Scheme<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"Failed to SetControllerReference, will requeue after a short time."</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">&#123;</span>RequeueAfter<span class="token punctuation">:</span> GenericRequeueDuration<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> err
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> newDp<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"Failed to create Deployment, will requeue after a short time."</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">&#123;</span>RequeueAfter<span class="token punctuation">:</span> GenericRequeueDuration<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> err
	<span class="token punctuation">&#125;</span>

	log<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"The Deployment has been created."</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="3-2-1-查询Deployument">3.2.1 查询Deployument</h5>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">log <span class="token operator">:=</span> log<span class="token punctuation">.</span><span class="token function">FromContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>

<span class="token keyword">var</span> dp <span class="token operator">=</span> <span class="token operator">&amp;</span>appsv1<span class="token punctuation">.</span>Deployment<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> types<span class="token punctuation">.</span>NamespacedName<span class="token punctuation">&#123;</span>
	Namespace<span class="token punctuation">:</span> app<span class="token punctuation">.</span>Namespace<span class="token punctuation">,</span>
	Name<span class="token punctuation">:</span>      app<span class="token punctuation">.</span>Name<span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> dp<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这一步比较常规，先根据Application的Namespace和Name信息来查询对应Deployment是否存在。</p>
<h5 id="3-2-2-没有错误发生时，更新状态">3.2.2 没有错误发生时，更新状态</h5>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
	log<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"The Deployment has already exist."</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> reflect<span class="token punctuation">.</span><span class="token function">DeepEqual</span><span class="token punctuation">(</span>dp<span class="token punctuation">.</span>Status<span class="token punctuation">,</span> app<span class="token punctuation">.</span>Status<span class="token punctuation">.</span>Workflow<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>

	app<span class="token punctuation">.</span>Status<span class="token punctuation">.</span>Workflow <span class="token operator">=</span> dp<span class="token punctuation">.</span>Status
	<span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"Failed to update Application status"</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">&#123;</span>RequeueAfter<span class="token punctuation">:</span> GenericRequeueDuration<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> err
	<span class="token punctuation">&#125;</span>
	log<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"The Application status has been updated."</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Deployment的status更新引起的调谐过程被触发。所以接下来判断dp.Status和app.Status.Workflow是否相等，如果不相等，则说明app.Status.Workflow需要更新。<br>
这里大家应该注意到Status更新用的是r.Status().Update()方法。</p>
<h5 id="3-2-3-NotFound之外的错误场景">3.2.3 NotFound之外的错误场景</h5>
<p>如果错误是NotFound，那么意味着需要创建一个新的Deployment资源实例，这个逻辑很明确，可以预见会有十几到二十行代码。而错误不是NotFound的时候呢？我们只能结束本轮调谐逻辑，选择指定一段时间后去重试。所以我们先写!NotFound的逻辑：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">if</span> <span class="token operator">!</span>errors<span class="token punctuation">.</span><span class="token function">IsNotFound</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"Failed to get Deployment, will requeue after a short time."</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">&#123;</span>RequeueAfter<span class="token punctuation">:</span> GenericRequeueDuration<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> err
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="3-2-4-NotFound的时候">3.2.4 NotFound的时候</h5>
<p>大家应该猜到了，这时要做的就是根据Application资源实例的信息来构造Deployment实例：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">
newDp <span class="token operator">:=</span> <span class="token operator">&amp;</span>appsv1<span class="token punctuation">.</span>Deployment<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
newDp<span class="token punctuation">.</span><span class="token function">SetName</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
newDp<span class="token punctuation">.</span><span class="token function">SetNamespace</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>Namespace<span class="token punctuation">)</span>
newDp<span class="token punctuation">.</span><span class="token function">SetLabels</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>Labels<span class="token punctuation">)</span>
newDp<span class="token punctuation">.</span>Spec <span class="token operator">=</span> app<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Deployment<span class="token punctuation">.</span>DeploymentSpec
newDp<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Template<span class="token punctuation">.</span><span class="token function">SetLabels</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>Labels<span class="token punctuation">)</span>

<span class="token keyword">if</span> err <span class="token operator">:=</span> ctrl<span class="token punctuation">.</span><span class="token function">SetControllerReference</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> newDp<span class="token punctuation">,</span> r<span class="token punctuation">.</span>Scheme<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
	log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"Failed to SetControllerReference, will requeue after a short time."</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">&#123;</span>RequeueAfter<span class="token punctuation">:</span> GenericRequeueDuration<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> err
<span class="token punctuation">&#125;</span>

<span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> newDp<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
	log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"Failed to create Deployment, will requeue after a short time."</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">&#123;</span>RequeueAfter<span class="token punctuation">:</span> GenericRequeueDuration<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> err
<span class="token punctuation">&#125;</span>

log<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"The Deployment has been created."</span><span class="token punctuation">)</span>
<span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>至此，Deployment资源的调谐逻辑也就写好了。</p>
<h4 id="3-3-实现Service调谐流程">3.3 实现Service调谐流程</h4>
<p>我们继续实现Service的调谐过程。在controllers目录下，即与application_controller.go源文件同级目录内创建一个service.go源文件来实现Service的调谐逻辑。<br>
同样先看图，如图7-3所示，Service的调谐逻辑和Deployment基本一致。</p>
<p><img src="/images/service_reconcile.png" alt="service_reconcile"></p>
<p>我们还是先查看代码，然后对照流程图中的步骤来详细解释：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>ApplicationReconciler<span class="token punctuation">)</span> <span class="token function">reconcileService</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> app <span class="token operator">*</span>dappsv1<span class="token punctuation">.</span>Application<span class="token punctuation">)</span> <span class="token punctuation">(</span>ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	log <span class="token operator">:=</span> log<span class="token punctuation">.</span><span class="token function">FromContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>

	<span class="token keyword">var</span> svc <span class="token operator">=</span> <span class="token operator">&amp;</span>corev1<span class="token punctuation">.</span>Service<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
	err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> types<span class="token punctuation">.</span>NamespacedName<span class="token punctuation">&#123;</span>
		Namespace<span class="token punctuation">:</span> app<span class="token punctuation">.</span>Namespace<span class="token punctuation">,</span>
		Name<span class="token punctuation">:</span>      app<span class="token punctuation">.</span>Name<span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> svc<span class="token punctuation">)</span>

	<span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"The Service has already exist."</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> reflect<span class="token punctuation">.</span><span class="token function">DeepEqual</span><span class="token punctuation">(</span>svc<span class="token punctuation">.</span>Status<span class="token punctuation">,</span> app<span class="token punctuation">.</span>Status<span class="token punctuation">.</span>Network<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
		<span class="token punctuation">&#125;</span>

		app<span class="token punctuation">.</span>Status<span class="token punctuation">.</span>Network <span class="token operator">=</span> svc<span class="token punctuation">.</span>Status
		<span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"Failed to update Application status"</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">&#123;</span>RequeueAfter<span class="token punctuation">:</span> GenericRequeueDuration<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> err
		<span class="token punctuation">&#125;</span>
		log<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"The Application status has been updated."</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> <span class="token operator">!</span>errors<span class="token punctuation">.</span><span class="token function">IsNotFound</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"Failed to get Service, will requeue after a short time."</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">&#123;</span>RequeueAfter<span class="token punctuation">:</span> GenericRequeueDuration<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> err
	<span class="token punctuation">&#125;</span>

	newSvc <span class="token operator">:=</span> <span class="token operator">&amp;</span>corev1<span class="token punctuation">.</span>Service<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
	newSvc<span class="token punctuation">.</span><span class="token function">SetName</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
	newSvc<span class="token punctuation">.</span><span class="token function">SetNamespace</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>Namespace<span class="token punctuation">)</span>
	newSvc<span class="token punctuation">.</span><span class="token function">SetLabels</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>Labels<span class="token punctuation">)</span>
	newSvc<span class="token punctuation">.</span>Spec <span class="token operator">=</span> app<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Service<span class="token punctuation">.</span>ServiceSpec
	newSvc<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Selector <span class="token operator">=</span> app<span class="token punctuation">.</span>Labels

	<span class="token keyword">if</span> err <span class="token operator">:=</span> ctrl<span class="token punctuation">.</span><span class="token function">SetControllerReference</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> newSvc<span class="token punctuation">,</span> r<span class="token punctuation">.</span>Scheme<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"Failed to SetControllerReference, will requeue after a short time."</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">&#123;</span>RequeueAfter<span class="token punctuation">:</span> GenericRequeueDuration<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> err
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> newSvc<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"Failed to create Service, will requeue after a short time."</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">&#123;</span>RequeueAfter<span class="token punctuation">:</span> GenericRequeueDuration<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> err
	<span class="token punctuation">&#125;</span>

	log<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"The Service has been created."</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="3-3-1-查询Service">3.3.1 查询Service</h5>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">log <span class="token operator">:=</span> log<span class="token punctuation">.</span><span class="token function">FromContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>

<span class="token keyword">var</span> svc <span class="token operator">=</span> <span class="token operator">&amp;</span>corev1<span class="token punctuation">.</span>Service<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> types<span class="token punctuation">.</span>NamespacedName<span class="token punctuation">&#123;</span>
	Namespace<span class="token punctuation">:</span> app<span class="token punctuation">.</span>Namespace<span class="token punctuation">,</span>
	Name<span class="token punctuation">:</span>      app<span class="token punctuation">.</span>Name<span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> svc<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这一步同样是通过Application的Namespace和Name信息来查询资源的，我们这里尝试去Get Service，查看这个Service是否存在。</p>
<h5 id="3-3-2-没错误发生时，更新状态">3.3.2 没错误发生时，更新状态</h5>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
	log<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"The Service has already exist."</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> reflect<span class="token punctuation">.</span><span class="token function">DeepEqual</span><span class="token punctuation">(</span>svc<span class="token punctuation">.</span>Status<span class="token punctuation">,</span> app<span class="token punctuation">.</span>Status<span class="token punctuation">.</span>Network<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>

	app<span class="token punctuation">.</span>Status<span class="token punctuation">.</span>Network <span class="token operator">=</span> svc<span class="token punctuation">.</span>Status
	<span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"Failed to update Application status"</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">&#123;</span>RequeueAfter<span class="token punctuation">:</span> GenericRequeueDuration<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> err
	<span class="token punctuation">&#125;</span>
	log<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"The Application status has been updated."</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这一步是通过比较svc.Status和app.Status.Network的差异来判断Service的Status是否发生了变化，如果有变化就去更新app.Status。</p>
<h5 id="3-3-3-NotFound以外的错误场景">3.3.3 NotFound以外的错误场景</h5>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">if</span> <span class="token operator">!</span>errors<span class="token punctuation">.</span><span class="token function">IsNotFound</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"Failed to get Service, will requeue after a short time."</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">&#123;</span>RequeueAfter<span class="token punctuation">:</span> GenericRequeueDuration<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> err
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>NotFound之外的错误处理，这里没有新的知识点，我们同样选择在1分钟后重试。</p>
<h5 id="3-3-4-NotFound的时候">3.3.4 NotFound的时候</h5>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">
newSvc <span class="token operator">:=</span> <span class="token operator">&amp;</span>corev1<span class="token punctuation">.</span>Service<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
newSvc<span class="token punctuation">.</span><span class="token function">SetName</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
newSvc<span class="token punctuation">.</span><span class="token function">SetNamespace</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>Namespace<span class="token punctuation">)</span>
newSvc<span class="token punctuation">.</span><span class="token function">SetLabels</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>Labels<span class="token punctuation">)</span>
newSvc<span class="token punctuation">.</span>Spec <span class="token operator">=</span> app<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Service<span class="token punctuation">.</span>ServiceSpec
newSvc<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Selector <span class="token operator">=</span> app<span class="token punctuation">.</span>Labels

<span class="token keyword">if</span> err <span class="token operator">:=</span> ctrl<span class="token punctuation">.</span><span class="token function">SetControllerReference</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> newSvc<span class="token punctuation">,</span> r<span class="token punctuation">.</span>Scheme<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
	log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"Failed to SetControllerReference, will requeue after a short time."</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">&#123;</span>RequeueAfter<span class="token punctuation">:</span> GenericRequeueDuration<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> err
<span class="token punctuation">&#125;</span>

<span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> newSvc<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
	log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"Failed to create Service, will requeue after a short time."</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">&#123;</span>RequeueAfter<span class="token punctuation">:</span> GenericRequeueDuration<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> err
<span class="token punctuation">&#125;</span>

log<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"The Service has been created."</span><span class="token punctuation">)</span>
<span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果Service不存在，就根据Application资源实例的信息来构造Service。至此，Service资源的调谐逻辑也就写好了。</p>
<h4 id="3-4-设置RBAC权限">3.4 设置RBAC权限</h4>
<p>我们在前面实现Deployment和Service的调谐逻辑之后，其实还有一个问题没有考虑到，就是这个Operator程序默认是没有权限操作Deployment和Service资源的。当然，我们不需要自己去编写RBAC配置，只需通过几行注释标记代码，工具会自动帮助我们生成相应的配置文件。<br>
回到controllers/application_controller.go文件的Reconcile()方法，可以看到Reconcile()方法上面有这样几行注释：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">//+kubebuilder:rbac:groups=apps.danielhu.cn,resources=applications,verbs=get;list;watch;create;update;patch;delete</span>
<span class="token comment">//+kubebuilder:rbac:groups=apps.danielhu.cn,resources=applications/status,verbs=get;update;patch</span>
<span class="token comment">//+kubebuilder:rbac:groups=apps.danielhu.cn,resources=applications/finalizers,verbs=update</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>在下方添加操作Deployment和Service相关的注释：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">//+kubebuilder:rbac:groups=apps,resources=deployments,verbs=get;list;watch;create;update;patch;delete</span>
<span class="token comment">//+kubebuilder:rbac:groups=apps,resources=deployments/status,verbs=get</span>
<span class="token comment">//+kubebuilder:rbac:groups=core,resources=services,verbs=get;list;watch;create;update;patch;delete</span>
<span class="token comment">//+kubebuilder:rbac:groups=core,resources=services/status,verbs=get</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后执行如下命令：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">make</span> manifests<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><strong>报错</strong></p>
<blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Error: not all generators ran successfully
run <span class="token variable"><span class="token variable">`</span>controller-gen rbac:roleName<span class="token operator">=</span>manager-role crd webhook <span class="token assign-left variable">paths</span><span class="token operator">=</span>./<span class="token punctuation">..</span>. output:crd:artifacts:config<span class="token operator">=</span>config/crd/bases <span class="token parameter variable">-w</span><span class="token variable">`</span></span> to see all available markers, or <span class="token variable"><span class="token variable">`</span>controller-gen rbac:roleName<span class="token operator">=</span>manager-role crd webhook <span class="token assign-left variable">paths</span><span class="token operator">=</span>./<span class="token punctuation">..</span>. output:crd:artifacts:config<span class="token operator">=</span>config/crd/bases <span class="token parameter variable">-h</span><span class="token variable">`</span></span> <span class="token keyword">for</span> usage
make: *** <span class="token punctuation">[</span>manifests<span class="token punctuation">]</span> 错误 <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</blockquote>
<blockquote>
<p>通过gpt提示，此处是缺少controller-gen工具，我下载并配置好了controller-gen，把它放在了相应的目录下。后面再次执行make manifests还是缺少一些工具，把他们下载下来就好了。</p>
<p>通过和gpt交互，其实我明白了一个问题：<strong>K8s在运行代码时报错，错误的关键信息往往在Error句的上面那句</strong>，因为K8s中它错误只指出<code> not all generators ran successfully</code> 这样一句废话，所以这里我们必须改掉自己写程序时候的习惯，**从Error往下看，这样是找不到错误的！**我之前真是太愚蠢了！</p>
<p>GPT是真的挺靠谱的！</p>
</blockquote>
<p>执行成功(来之不易)</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@master application-operator<span class="token punctuation">]</span><span class="token comment"># make manifests</span>
/root/MyOPeratorProjects/application-operator/bin/controller-gen rbac:roleName<span class="token operator">=</span>manager-role crd webhook <span class="token assign-left variable">paths</span><span class="token operator">=</span><span class="token string">"./..."</span> output:crd:artifacts:config<span class="token operator">=</span>config/crd/ba<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>这时打开config/rbac/目录下的role.yaml，可以看到如下配置：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> manager<span class="token punctuation">-</span>role
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> apps
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> deployments
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> create
  <span class="token punctuation">-</span> delete
  <span class="token punctuation">-</span> get
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> patch
  <span class="token punctuation">-</span> update
  <span class="token punctuation">-</span> watch
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> apps
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> deployments/status
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> get
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> apps.danielhu.cn
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> applications
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> create
  <span class="token punctuation">-</span> delete
  <span class="token punctuation">-</span> get
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> patch
  <span class="token punctuation">-</span> update
  <span class="token punctuation">-</span> watch
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> apps.danielhu.cn
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> applications/finalizers
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> update
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> apps.danielhu.cn
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> applications/status
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> get
  <span class="token punctuation">-</span> patch
  <span class="token punctuation">-</span> update
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">""</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> services
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> create
  <span class="token punctuation">-</span> delete
  <span class="token punctuation">-</span> get
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> patch
  <span class="token punctuation">-</span> update
  <span class="token punctuation">-</span> watch
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">""</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> services/status
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> get<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="3-5-过滤调谐事件">3.5 过滤调谐事件</h4>
<p>什么情况下调谐逻辑需要被触发执行一次？</p>
<p><strong>Application创建时</strong>，肯定是需要执行的，也是整个程序逻辑的第一步。<strong>Application发生变更时</strong>，其实需要根据新的Application中的配置来决定是否需要更新已有的Deployment和Service资源实例。目前我们在调谐Deployment和Service时并没有做得那么完善，只考虑了新建的情况。</p>
<p>再来考虑<strong>Application的Status发生变更时</strong>应该如何处理：明显我们在运行中会根据Deployment和Service资源实例的Status变化来更新Application的Status，如果这时Status更新了，如果再触发一次调谐，其实这次调谐是没有意义的。</p>
<p>另外，我们也想办法让Deployment和Service的一些变化事件能够选择性地触发调谐逻辑的运行，所以还需要在SetupWithManager()方法中添加一些程序逻辑。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// SetupWithManager sets up the controller with the Manager.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>ApplicationReconciler<span class="token punctuation">)</span> <span class="token function">SetupWithManager</span><span class="token punctuation">(</span>mgr ctrl<span class="token punctuation">.</span>Manager<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	setupLog <span class="token operator">:=</span> ctrl<span class="token punctuation">.</span>Log<span class="token punctuation">.</span><span class="token function">WithName</span><span class="token punctuation">(</span><span class="token string">"setup"</span><span class="token punctuation">)</span>

	<span class="token keyword">return</span> ctrl<span class="token punctuation">.</span><span class="token function">NewControllerManagedBy</span><span class="token punctuation">(</span>mgr<span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">For</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dappsv1<span class="token punctuation">.</span>Application<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> builder<span class="token punctuation">.</span><span class="token function">WithPredicates</span><span class="token punctuation">(</span>predicate<span class="token punctuation">.</span>Funcs<span class="token punctuation">&#123;</span>
			CreateFunc<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>event event<span class="token punctuation">.</span>CreateEvent<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">return</span> <span class="token boolean">true</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
			DeleteFunc<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>event event<span class="token punctuation">.</span>DeleteEvent<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span>
				setupLog<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"The Application has been deleted."</span><span class="token punctuation">,</span>
					<span class="token string">"name"</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>Object<span class="token punctuation">.</span><span class="token function">GetName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token keyword">return</span> <span class="token boolean">false</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
			UpdateFunc<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>event event<span class="token punctuation">.</span>UpdateEvent<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">if</span> event<span class="token punctuation">.</span>ObjectNew<span class="token punctuation">.</span><span class="token function">GetResourceVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> event<span class="token punctuation">.</span>ObjectOld<span class="token punctuation">.</span><span class="token function">GetResourceVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
					<span class="token keyword">return</span> <span class="token boolean">false</span>
				<span class="token punctuation">&#125;</span>
				<span class="token keyword">if</span> reflect<span class="token punctuation">.</span><span class="token function">DeepEqual</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>ObjectNew<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>dappsv1<span class="token punctuation">.</span>Application<span class="token punctuation">)</span><span class="token punctuation">.</span>Spec<span class="token punctuation">,</span> event<span class="token punctuation">.</span>ObjectOld<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>dappsv1<span class="token punctuation">.</span>Application<span class="token punctuation">)</span><span class="token punctuation">.</span>Spec<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
					<span class="token keyword">return</span> <span class="token boolean">false</span>
				<span class="token punctuation">&#125;</span>
				<span class="token keyword">return</span> <span class="token boolean">true</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token comment">// 1. Deployment</span>
		<span class="token function">Owns</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>appsv1<span class="token punctuation">.</span>Deployment<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> builder<span class="token punctuation">.</span><span class="token function">WithPredicates</span><span class="token punctuation">(</span>predicate<span class="token punctuation">.</span>Funcs<span class="token punctuation">&#123;</span>
			CreateFunc<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>event event<span class="token punctuation">.</span>CreateEvent<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">return</span> <span class="token boolean">false</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
			DeleteFunc<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>event event<span class="token punctuation">.</span>DeleteEvent<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span>
				setupLog<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"The Deployment has been deleted."</span><span class="token punctuation">,</span>
					<span class="token string">"name"</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>Object<span class="token punctuation">.</span><span class="token function">GetName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token keyword">return</span> <span class="token boolean">true</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
			UpdateFunc<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>event event<span class="token punctuation">.</span>UpdateEvent<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">if</span> event<span class="token punctuation">.</span>ObjectNew<span class="token punctuation">.</span><span class="token function">GetResourceVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> event<span class="token punctuation">.</span>ObjectOld<span class="token punctuation">.</span><span class="token function">GetResourceVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
					<span class="token keyword">return</span> <span class="token boolean">false</span>
				<span class="token punctuation">&#125;</span>
				<span class="token keyword">if</span> reflect<span class="token punctuation">.</span><span class="token function">DeepEqual</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>ObjectNew<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>appsv1<span class="token punctuation">.</span>Deployment<span class="token punctuation">)</span><span class="token punctuation">.</span>Spec<span class="token punctuation">,</span> event<span class="token punctuation">.</span>ObjectOld<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>appsv1<span class="token punctuation">.</span>Deployment<span class="token punctuation">)</span><span class="token punctuation">.</span>Spec<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
					<span class="token keyword">return</span> <span class="token boolean">false</span>
				<span class="token punctuation">&#125;</span>
				<span class="token keyword">return</span> <span class="token boolean">true</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
			GenericFunc<span class="token punctuation">:</span> <span class="token boolean">nil</span><span class="token punctuation">,</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token comment">// 2. Service</span>
		<span class="token function">Owns</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>corev1<span class="token punctuation">.</span>Service<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> builder<span class="token punctuation">.</span><span class="token function">WithPredicates</span><span class="token punctuation">(</span>predicate<span class="token punctuation">.</span>Funcs<span class="token punctuation">&#123;</span>
			CreateFunc<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>event event<span class="token punctuation">.</span>CreateEvent<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">return</span> <span class="token boolean">false</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
			DeleteFunc<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>event event<span class="token punctuation">.</span>DeleteEvent<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span>
				setupLog<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"The Service has been deleted."</span><span class="token punctuation">,</span>
					<span class="token string">"name"</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>Object<span class="token punctuation">.</span><span class="token function">GetName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token keyword">return</span> <span class="token boolean">true</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
			UpdateFunc<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>event event<span class="token punctuation">.</span>UpdateEvent<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">if</span> event<span class="token punctuation">.</span>ObjectNew<span class="token punctuation">.</span><span class="token function">GetResourceVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> event<span class="token punctuation">.</span>ObjectOld<span class="token punctuation">.</span><span class="token function">GetResourceVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
					<span class="token keyword">return</span> <span class="token boolean">false</span>
				<span class="token punctuation">&#125;</span>
				<span class="token keyword">if</span> reflect<span class="token punctuation">.</span><span class="token function">DeepEqual</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>ObjectNew<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>dappsv1<span class="token punctuation">.</span>Application<span class="token punctuation">)</span><span class="token punctuation">.</span>Spec<span class="token punctuation">,</span> event<span class="token punctuation">.</span>ObjectOld<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>dappsv1<span class="token punctuation">.</span>Application<span class="token punctuation">)</span><span class="token punctuation">.</span>Spec<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
					<span class="token keyword">return</span> <span class="token boolean">false</span>
				<span class="token punctuation">&#125;</span>
				<span class="token keyword">return</span> <span class="token boolean">true</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Complete</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里有三块代码逻辑：Application、Deployment和Service。我们逐个进行分析。</p>
<h5 id="3-5-1-Application">3.5.1 Application</h5>
<p>对于Application来说，Create事件肯定是无条件处理的；Delete其实不需要做资源清理工作，因为在创建Deployment和Service时都写过类似的代码：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">if</span> err <span class="token operator">:=</span> ctrl<span class="token punctuation">.</span><span class="token function">SetControllerReference</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> newDp<span class="token punctuation">,</span> r<span class="token punctuation">.</span>Scheme<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
	log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"Failed to SetControllerReference, will requeue after a short time."</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">&#123;</span>RequeueAfter<span class="token punctuation">:</span> GenericRequeueDuration<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> err
<span class="token punctuation">&#125;</span><span class="token comment">//来自deployment.go</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>这些代码的作用就是将当前创建的Deployment资源设置成Application类型的app资源的子资源，这样当对应的Application类型实例被删除时，这个Deployment类型的资源实例就会被系统的垃圾回收系统回收。</p>
<p>Update时需要获取Application中更新的内容，然后将其应用到已创建好的Deployment和Service资源实例中。为了不使得这个项目过于复杂，我们在这次试验不展开说明这段程序逻辑。<br>
所以最后For函数应该是这样的：</p>
<blockquote>
<p>Notes：</p>
<p>以上内容均为个人学习过程中的理解，理解和总结可能有偏差。文章内容会随着学习过程不断修改完善。</p>
<p>如果以上有错误欢迎指出。</p>
</blockquote>

</div>

<!-- post-guide -->

    <div class="post-guide">
        <div class="item left">
            
              <a href="/2023/04/27/7.5.%20%E3%80%90%E6%95%85%E9%9A%9C%E3%80%91%E4%B8%80%E5%8F%B0%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%99%BB%E9%99%86%E4%B8%8D%E8%BF%9B%E5%8E%BB%E4%BA%86/">
                  <i class="fa fa-angle-left" aria-hidden="true"></i>
                  【故障】一台虚拟机登陆不进去了
              </a>
            
        </div>
        <div class="item right">
            
              <a href="/2023/04/27/8.%20k8s%20api%E5%AD%A6%E4%B9%A0/">
                curl方式和raw方式访问api server
                <i class="fa fa-angle-right" aria-hidden="true"></i>
              </a>
            
        </div>
    </div>


<!-- comment - giscus -->


<!-- comment - valine -->


<script>
	
	
</script>
	</div>
	<div id="footer">
	<p>
	©<span id="footerYear-start"></span>-<span id="footerYear-end"></span>
	<a href="/">倪克松</a> 
	
	
	<br>
	Theme <a href="//github.com/wujun234/hexo-theme-tree" target="_blank">Tree</a>
	by <a href="//github.com/wujun234" target="_blank">WuJun</a>
	Powered by <a href="//hexo.io" target="_blank">Hexo</a>
	</p>
</div>


<script type="text/javascript">
	document.getElementById('footerYear-start').innerHTML = new Date().getFullYear() + '';
</script>

<script type="text/javascript">
	document.getElementById('footerYear-end').innerHTML = new Date().getFullYear() + '';
</script>

	<button id="totop-toggle" class="toggle"><i class="fa fa-angle-double-up" aria-hidden="true"></i></button>
</body>
</html>