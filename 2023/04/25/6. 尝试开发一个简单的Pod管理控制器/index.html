<!DOCTYPE html>
<html lang="en">

<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
	
	<!-- title -->
	
	<title>
	
		å°è¯•å¼€å‘ä¸€ä¸ªç®€å•çš„Podç®¡ç†æ§åˆ¶å™¨ | 
	 
	å€ªå…‹æ¾çš„åšå®¢
	</title>
	
	<!-- keywords,description -->
	 

	<!-- favicon -->
	
	<link rel="shortcut icon" href="/favicon.ico">
	


	<!-- search -->
	<script>
		var searchEngine = "https://www.google.com/search?q=";
		if(typeof searchEngine == "undefined" || searchEngine == null || searchEngine == ""){
			searchEngine = "https://www.google.com/search?q=";
		}
		var homeHost = "";
		if(typeof homeHost == "undefined" || homeHost == null || homeHost == ""){
			homeHost = window.location.host;
		}
	</script>


	
<link rel="stylesheet" href="/css/main.css">

	
<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css">

	
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.17.1/build/styles/darcula.min.css">

	
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">


	
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>

	
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>

	
<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.17.1/build/highlight.min.js"></script>

	
<script src="https://cdn.jsdelivr.net/npm/jquery-pjax@2.0.1/jquery.pjax.min.js"></script>

	
<script src="/js/main.js"></script>


	
		
<script src="https://cdn.jsdelivr.net/npm/leancloud-storage/dist/av-min.js"></script>

		
<script src="https://cdn.jsdelivr.net/npm/valine@v1.5.1/dist/Valine.min.js"></script>

	
	

<meta name="generator" content="Hexo 6.3.0"></head>

<body>
	<header id="header">
    <a id="title" href="/" class="logo">å€ªå…‹æ¾çš„åšå®¢</a>

	<ul id="menu">
    

    

    

    
      
      
        <li class="menu-item">
          <a href='https://github.com/NikeSong' class="menu-item-link" target="_blank">
            Nicolson
          </a>
        </li>
      
    
  
    
      <li class="menu-item">
        <a href='https://github.com/NikeSong' class="menu-item-link" target="_blank">
          <i class="fa fa-github fa-2x"></i>
        </a>
      </li>
    
	</ul>
</header>

	
<div id="sidebar">
	<button id="sidebar-toggle" class="toggle" ><i class="fa fa-arrow-right " aria-hidden="true"></i></button>
	
	<div id="site-toc">
		<input id="search-input" class="search-input" type="search" placeholder="æŒ‰å›è½¦å…¨ç«™æœç´¢">
		<div id="tree">
			

			
							<ul>
								<li class="file">
									<a href="/2023/04/23/1.%20Kubernetes%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/">
                     
										    KubernetesåŸºæœ¬ç»“æ„
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/04/28/10.%20%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Client-go%E5%AE%9E%E7%8E%B0%E6%9C%BA%E7%90%86/">
                     
										    æ·±å…¥å­¦ä¹ Client-Goå®ç°æœºç†ï¼ˆè¿›è¡Œä¸­ï¼‰
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/04/27/11.%20Operator%E5%BC%80%E5%8F%91%E8%BF%9B%E9%98%B6/">
                     
										    Operatorå¼€å‘è¿›é˜¶ï¼ˆè¿›è¡Œä¸­ï¼‰
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/04/28/12.%20Deployment%20Controller%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">
                     
										    Deployment Controlleræºç åˆ†æ(æœªå¼€å§‹)
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/04/23/2.%20Pod%E7%BB%86%E8%8A%82%E5%88%86%E6%9E%90/">
                     
										    Podç»†èŠ‚åˆ†æ
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/04/24/3.%20K8s%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2/">
                     
										    K8sæœåŠ¡æš´éœ²
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/04/24/4.%20%E6%8E%A2%E7%A7%98Docker%E5%AE%B9%E5%99%A8%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/">
                     
										    æ¢ç§˜Dockerå®¹å™¨çš„å®ç°åŸç†ï¼ˆè¿›è¡Œä¸­ï¼‰
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/04/25/5.%20%E4%BB%80%E4%B9%88%E6%98%AFOperator/">
                     
										    ä»€ä¹ˆæ˜¯Operator
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file active">
									<a href="/2023/04/25/6.%20%E5%B0%9D%E8%AF%95%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84Pod%E7%AE%A1%E7%90%86%E6%8E%A7%E5%88%B6%E5%99%A8/">
                     
										    å°è¯•å¼€å‘ä¸€ä¸ªç®€å•çš„Podç®¡ç†æ§åˆ¶å™¨
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/04/26/7.%20%E3%80%90%E6%95%85%E9%9A%9C%E3%80%91K8s%E7%BB%84%E4%BB%B6%E7%89%88%E6%9C%AC%E5%87%BA%E9%97%AE%E9%A2%98/">
                     
										    ã€æ•…éšœã€‘K8sç»„ä»¶ç‰ˆæœ¬å‡ºé—®é¢˜
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/04/27/7.5.%20%E3%80%90%E6%95%85%E9%9A%9C%E3%80%91%E4%B8%80%E5%8F%B0%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%99%BB%E9%99%86%E4%B8%8D%E8%BF%9B%E5%8E%BB%E4%BA%86/">
                     
										    ã€æ•…éšœã€‘ä¸€å°è™šæ‹Ÿæœºç™»é™†ä¸è¿›å»äº†
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/04/27/8.%20k8s%20api%E5%AD%A6%E4%B9%A0/">
                     
										    curlæ–¹å¼å’Œrawæ–¹å¼è®¿é—®api server
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/04/28/9.%20GVK-%E7%BB%84%E3%80%81%E7%89%88%E6%9C%AC%E5%92%8C%E7%B1%BB%E5%9E%8B/">
                     
										    GVKå’ŒGVR
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
		</div>
	</div>
</div>

	<!-- å¼•å…¥æ­£æ–‡ -->
	<div id="content">
		<h1 id="article-title">
	å°è¯•å¼€å‘ä¸€ä¸ªç®€å•çš„Podç®¡ç†æ§åˆ¶å™¨
</h1>

<!-- meta -->
<div class="article-meta">
	

	<span>å€ªå…‹æ¾</span>
	<span>2023-04-25 14:58:00</span>

  <div id="article-categories">
    
		  <span>Categoriesï¼š</span>
      
          
              <span>
                  <i class="fa fa-folder" aria-hidden="true">
                  <a href="/categories/Kuberneteså­¦ä¹ ç¬”è®°/">Kuberneteså­¦ä¹ ç¬”è®°</a>
                  </i>
                
              </span>
          
      
    

    
		    <span>Tagsï¼š</span>
        
    
  </div>

</div>

<!-- content -->
<div id="article-content">
	<h2 id="å¼€å‘ä¸€ä¸ªPodç®¡ç†æ§åˆ¶å™¨">å¼€å‘ä¸€ä¸ªPodç®¡ç†æ§åˆ¶å™¨</h2>
<h3 id="1-å¼€å‘ç›®æ ‡">1. å¼€å‘ç›®æ ‡</h3>
<p>ç±»æ¯”äºDeploymentå¯ä»¥ç®¡ç†Podï¼Œæˆ‘ä»¬ç°åœ¨å°è¯•å¼€å‘ä¸€ä¸ªç®€å•çš„Podç®¡ç†æ§åˆ¶å™¨Application Operatorï¼Œä½†æ˜¯æš‚æ—¶åªæ”¯æŒPodå‰¯æœ¬æ•°çš„ç®¡ç†ã€‚</p>
<p>æˆ‘ä»¬è¦é€šè¿‡ä¸€ä¸ªApplicationç±»å‹æ¥å®šä¹‰ä¸€ä¸ªè‡ªå·±çš„èµ„æºå¯¹è±¡ï¼Œç„¶ååœ¨æ§åˆ¶å™¨ä¸­è·å–è¿™ä¸ªèµ„æºå¯¹è±¡çš„è¯¦ç»†é…ç½®ï¼Œæ¥ç€æ ¹æ®å®ƒçš„é…ç½®å»åˆ›å»ºç›¸åº”æ•°é‡çš„Podï¼Œå°±åƒDe-ploymenté‚£æ ·å·¥ä½œã€‚å½“ç„¶ï¼Œä¸ºäº†é¿å…Demoé¡¹ç›®è¿‡äºå¤æ‚ï¼Œè¿™é‡Œä¸å»è€ƒè™‘è¿‡å¤šçš„å¼‚å¸¸å¤„ç†ã€ç¨‹åºå¥å£®æ€§ã€ä¸šåŠ¡é€»è¾‘å®Œå¤‡ç­‰ã€‚</p>
<p><img src="/images/application_operator_function.png" alt="that's the way"></p>
<h3 id="2-åˆå§‹åŒ–é¡¹ç›®">2. åˆå§‹åŒ–é¡¹ç›®</h3>
<p>åˆ›å»ºæ–‡ä»¶å¤¹ç»„ï¼Œåˆ›å»ºæ–‡ä»¶å¤¹ï¼Œåœ¨é‡Œé¢æ‰§è¡Œä»¥ä¸‹è¯­å¥</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubebuilder init --domain=danielhu.cn --repo=github.com/daniel-hutao/application-operator --owner Daniel.Hu</span><br></pre></td></tr></table></figure>
<p>å‚æ•°å«ä¹‰</p>
<ul>
<li><code>â€“-domain lailin.xyz</code> æˆ‘ä»¬çš„é¡¹ç›®çš„åŸŸå</li>
<li><code>--repo xxx</code> æ˜¯ä»“åº“åœ°å€ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ <code>go mode</code> ä¸­çš„ <code>repo</code> åœ°å€</li>
</ul>
<p><strong>æŠ¥é”™1ï¼š</strong></p>
<blockquote>
<p>å¦‚æœä½  <code>golang</code> ç‰ˆæœ¬è¿‡ä½æˆ–è€…è¿‡é«˜éƒ½æœ‰å¯èƒ½å‡ºç°ä¸‹æ–¹çš„é”™è¯¯ä¿¡æ¯ï¼Œæˆ‘è¿™é‡Œæ˜¯å› ä¸ºä½¿ç”¨çš„ <code>1.16</code> ç‰ˆæœ¬å¤ªé«˜äº†</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2021/04/25 20:47:14 failed to initialize project: unable to run pre-scaffold tasks of &quot;base.go.kubebuilder.io/v3&quot;: go version &#x27;go1.16&#x27; is incompatible because &#x27;requires 1.13 &lt;= version &lt; 1.16&#x27;. You can skip this check using the --skip-go-version-check flag</span><br></pre></td></tr></table></figure>
<p>è¿™ç§æƒ…å†µä¸‹å¯ä»¥æ·»åŠ  <code>--skip-go-version-check</code> å¿½ç•¥è¿™ä¸ªé”™è¯¯</p>
</blockquote>
<p><strong>æŠ¥é”™2ï¼š</strong></p>
<blockquote>
<p>æ‰¾ä¸åˆ°go</p>
<p>export PATH=$PATH:/usr/local/go/bin</p>
<p>ä¸Šè¿°æ–¹æ³•çš„PATH åœ¨ç»ˆç«¯å…³é—­ åå°±ä¼šæ¶ˆå¤±ã€‚æ‰€ä»¥è¿˜æ˜¯å»ºè®®é€šè¿‡ç¼–è¾‘/etc/profileæ¥æ”¹PATHï¼Œä¹Ÿå¯ä»¥ä¿®æ”¹å®¶ç›®å½•ä¸‹çš„.bashrc(å³ï¼š~/.bashrc)ã€‚</p>
<blockquote>
<p>ä¿®æ”¹ç¯å¢ƒå˜é‡</p>
<ul>
<li>
<pre><code>vi /etc/profile
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- æœ€ä¸‹é¢åŠ ä¸Šï¼š</span><br><span class="line"></span><br></pre></td></tr></table></figure>
export PATH=$PATH:/usr/local/xxx/bin
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- åˆ·æ–°ç¯å¢ƒå˜é‡</span><br><span class="line"></span><br></pre></td></tr></table></figure>
source /etc/profile
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**æŠ¥é”™3ï¼š**</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</code></pre>
</li>
</ul>
</blockquote>
<p>Error: failed to initialize project: unable to scaffold with â€œ<a target="_blank" rel="noopener" href="http://base.go.kubebuilder.io/ve">base.go.kubebuilder.io/ve</a>â€: exit status l</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Goçš„ç‰ˆæœ¬ä¸åŒ¹é…ï¼Œæˆ‘ç”¨çš„æ˜¯1.17.6ï¼Œæ”¹ä¸º1.10.4ï¼Œçœ‹åˆ°åˆ«äººç”¨1.18.5æ”¹ä¸º1.18.5</span><br><span class="line"></span><br><span class="line">&gt; ä»ç„¶æŠ¥é”™ï¼Œç ”ç©¶ä¸€ä¸‹åˆ + ä¸€æ™šä¸Šçœ‹äº†å„ç§æ–‡æ¡£å’Œissueä»ç„¶è§£å†³ä¸äº†ï¼Œå¿ƒå¦‚æ­»ç°æ¬²å“­æ— æ³ªï¼Œæ­£å‡†å¤‡æ˜å¤©æŠŠè™šæ‹Ÿæœºä»å¤´åˆ°å°¾éƒ½æ¢æˆå’Œæ•™ç¨‹åŒæ ·çš„ç‰ˆæœ¬æ—¶è·Ÿå®¤å‹æŠ±æ€¨èµ·è¿™ä¸ªé—®é¢˜ã€‚</span><br><span class="line">&gt;</span><br><span class="line">&gt; ä»–å¾ˆæ„Ÿå…´è¶£ï¼Œè¶´æˆ‘ç”µè„‘æ—è¾¹çœ‹é—®é¢˜ï¼Œæˆ‘å½“æ—¶å›å®¿èˆç”¨çš„æ˜¯è‡ªå·±ç¬”è®°æœ¬è¿œç¨‹ç™»é™†å®éªŒå®¤ç”µè„‘ï¼Œå®éªŒå®¤ç”µè„‘å¼€è™šæ‹Ÿæœº+vpnï¼Œä¸€æ‰“å¼€vpnæ•´ä¸ªç”»é¢å¡æˆPPTï¼Œä½†æ˜¯å°±åœ¨è¿™æ ·çš„æç«¯æ¶åŠ£çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åˆæ¢è°·æ­Œæœç´¢çœ‹äº†å‡ ä¸ªæ–‡ç« ï¼Œä»æœªè§£å†³ã€‚</span><br><span class="line">&gt;</span><br><span class="line">&gt; åæ¥ä»–è¯´ä½ æŠŠè¿™ä¸ªæŠ¥é”™ä¿¡æ¯å‘ç»™æˆ‘æˆ‘å†çœ‹çœ‹ï¼Œä»–æ”¶åˆ°åç¬¬ä¸€æ—¶é—´æ‰“å¼€äº†ChatGPTğŸ˜‚GPTè¯´å¯èƒ½æ˜¯GOBINç¯å¢ƒæ²¡é…å¥½ï¼Œæˆ‘åˆæ£€æŸ¥äº†ç¯å¢ƒï¼Œè¯´å¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜ï¼Œæˆ‘å¯»æ€ç½‘ç»œèƒ½æœ‰å•¥é—®é¢˜ï¼Œæˆ‘pingé›†ç¾¤pingç™¾åº¦éƒ½æ²¡é—®é¢˜ã€‚ã€‚ã€‚ã€‚</span><br><span class="line">&gt;</span><br><span class="line">&gt; ã€‚ã€‚ã€‚ã€‚</span><br><span class="line">&gt;</span><br><span class="line">&gt; ã€‚ã€‚ã€‚ã€‚</span><br><span class="line">&gt;</span><br><span class="line">&gt; å§æ§½ï¼Œæˆ‘ä¹‹å‰åˆå§‹åŒ–é¡¹ç›®çš„æ—¶å€™æ˜¯ä¸æ˜¯éƒ½æ²¡å¼€VPNï¼Ÿ</span><br><span class="line">&gt;</span><br><span class="line">&gt; æˆ‘è¯•ç€æ‰“å¼€VPNï¼Œé‡æ–°æ•²å…¥é‚£å¥ä»Šå¤©å·²ç»æ•²äº†100éçš„å‘½ä»¤`kubebuilder init XXXX`,å®ƒç«Ÿç„¶å¼€å§‹æ˜¾ç¤ºåœ¨githubä¸Šä¸‹è½½goçš„ä»€ä¹ˆä»€ä¹ˆä¸œè¥¿ï¼Œä¸€é•¿ä¸²å æ»¡äº†å±å¹•ã€‚ã€‚ã€‚æ­¤æ—¶æˆ‘å·²å‘†ä½ã€‚</span><br><span class="line">&gt;</span><br><span class="line">&gt; é—®é¢˜è§£å†³ã€‚</span><br><span class="line">&gt;</span><br><span class="line">&gt; (ä¹‹å‰ä¸€ç›´è§‰å¾—chatGPTè¢«å¹å¾—è¿‡å¤´äº†ï¼Œäº§ç”Ÿäº†å¾ˆåæ„Ÿçš„æƒ…ç»ªï¼Œè§‰å¾—ä¹Ÿå°±æ˜¯å¤–è¡Œäººæ‰æŠŠå®ƒè§†ä½œç¥æ˜ï¼Œå¹ä¸Šäº†å¤©ã€‚ç°åœ¨æ„Ÿè§‰è¿™ç©æ„è¿˜æ˜¯èƒ½æä¾›ä¸€äº›æ€è·¯çš„)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**é¡¹ç›®æ–‡ä»¶ç»“æ„åˆ†æ**</span><br><span class="line"></span><br><span class="line">åˆå§‹åŒ–å®Œä¹‹åæˆ‘çš„é¡¹ç›®ç»“æ„</span><br><span class="line"></span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ config</span><br><span class="line">â”‚   â”œâ”€â”€ default</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ manager_auth_proxy_patch.yaml</span><br><span class="line">â”‚   â”‚   â””â”€â”€ manager_config_patch.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ manager</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ controller_manager_config.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚   â”‚   â””â”€â”€ manager.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ prometheus</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚   â”‚   â””â”€â”€ monitor.yaml</span><br><span class="line">â”‚   â””â”€â”€ rbac</span><br><span class="line">â”‚       â”œâ”€â”€ auth_proxy_client_clusterrole.yaml</span><br><span class="line">â”‚       â”œâ”€â”€ auth_proxy_role_binding.yaml</span><br><span class="line">â”‚       â”œâ”€â”€ auth_proxy_role.yaml</span><br><span class="line">â”‚       â”œâ”€â”€ auth_proxy_service.yaml</span><br><span class="line">â”‚       â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚       â”œâ”€â”€ leader_election_role_binding.yaml</span><br><span class="line">â”‚       â”œâ”€â”€ leader_election_role.yaml</span><br><span class="line">â”‚       â”œâ”€â”€ role_binding.yaml</span><br><span class="line">â”‚       â””â”€â”€ service_account.yaml</span><br><span class="line">â”œâ”€â”€ Dockerfile</span><br><span class="line">â”œâ”€â”€ go.mod</span><br><span class="line">â”œâ”€â”€ go.sum</span><br><span class="line">â”œâ”€â”€ hack</span><br><span class="line">â”‚   â””â”€â”€ boilerplate.go.txt</span><br><span class="line">â”œâ”€â”€ main.go</span><br><span class="line">â”œâ”€â”€ Makefile</span><br><span class="line">â”œâ”€â”€ PROJECT</span><br><span class="line">â””â”€â”€ README.md</span><br><span class="line"></span><br><span class="line">å¤§è‡´çœ‹ä¸€ä¸‹å…¶ä¸­çš„å‡ ä¸ªæ–‡ä»¶</span><br><span class="line"></span><br><span class="line">- PROJECTï¼šè®°å½•å…ƒæ•°æ®</span><br><span class="line">- main.goï¼šé‡è¦çš„æ–‡ä»¶ï¼Œæ­¤å¤„å…ˆä¸åšåˆ†æã€‚æ³¨æ„åˆ°æ–‡ä»¶å¤´æœ‰copyrightä¿¡æ¯ï¼Œè¿™ä¸ªä¿¡æ¯æ¥è‡ªhack/boilerplate.go.txtæ–‡ä»¶ã€‚</span><br><span class="line">- configï¼šè¿™ä¸ªç›®å½•ä¸­æ”¾ç½®äº†å¾ˆå¤šä¸ªYAMLæ–‡ä»¶ã€‚å…¶ä¸­åŒ…æ‹¬RBACæƒé™ç›¸å…³çš„YAMLæ–‡ä»¶ã€Prometheusç›‘æ§æœåŠ¡å‘ç°ï¼ˆServiceMonitorï¼‰ç›¸å…³çš„YAMLæ–‡ä»¶ã€æ§åˆ¶å™¨ï¼ˆManagerï¼‰æœ¬èº«éƒ¨ç½²çš„YAMLæ–‡ä»¶ç­‰ã€‚</span><br><span class="line">- Dockerfileï¼šæœ€ç»ˆOperatorç¨‹åºç¼–è¯‘ã€æ„å»ºé•œåƒçš„é€»è¾‘å°±åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿®æ”¹è¿™ä¸ªæ–‡ä»¶æ¥è§£å†³ä¸€äº›é•œåƒæ„å»ºç›¸å…³çš„é—®é¢˜ï¼Œæ¯”å¦‚Goè¯­è¨€ä¾èµ–ä¸‹è½½çš„é»˜è®¤GOPROXYé…ç½®åœ¨å›½å†…ä¸ä¸€å®šèƒ½è®¿é—®åˆ°ï¼Œå¯ä»¥åœ¨å…¶ä¸­é…ç½®å›½å†…çš„proxyåœ°å€ç­‰ã€‚</span><br><span class="line">- Makefileï¼šè¿™æ˜¯è§£æ”¾åŠ³åŠ¨åŠ›çš„å·¥å…·ï¼Œè¿™é‡Œå®ç°äº†é€šè¿‡make Ã—Ã—Ã—è½»æ¾å®ç°æ•´ä¸ªç¨‹åºçš„ç¼–è¯‘æ„å»ºã€é•œåƒæ¨é€ã€éƒ¨ç½²ã€å¸è½½ç­‰æ“ä½œï¼Œåé¢ä¼šç»å¸¸ç”¨åˆ°ã€‚</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 3. æ·»åŠ API</span><br><span class="line"></span><br><span class="line">åœ¨application-operatorç›®å½•ä¸‹ç»§ç»­æ‰§è¡Œå‘½ä»¤ï¼Œè¿ç»­è¾“å…¥ä¸¤æ¬¡yï¼š</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</blockquote>
<p>kubebuilder create api --group apps --version v1 --kind Application</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>
<p>[root@master application-operator]# kubebuilder create api --group apps --version v1 --kind Application<br>
Create Resource [y/n]<br>
y<br>
Create Controller [y/n]<br>
y<br>
Writing kustomize manifests for you to editâ€¦<br>
Writing scaffold for you to editâ€¦<br>
api/v1/application_types.go<br>
controllers/application_controller.go<br>
Update dependencies:<br>
$ go mod tidy<br>
go: downloading <a href="http://github.com/onsi/ginkgo/v2">github.com/onsi/ginkgo/v2</a> v2.0.0<br>
Running make:<br>
$ make generate<br>
â€¦</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">æ–°å¢äº†å¾ˆå¤šæ–‡ä»¶å¤¹å’Œæ–‡ä»¶ï¼Œå°¤å…¶æ˜¯apiæ–‡ä»¶å¤¹æ¯”è¾ƒé‡è¦ï¼›éƒ¨åˆ†æ–‡ä»¶æœ‰æ”¹åŠ¨ï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡git statusè§‚å¯Ÿåˆ°ã€‚</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 4. CRDå®ç°å’Œéƒ¨ç½²</span><br><span class="line"></span><br><span class="line">æˆ‘ä»¬å‰é¢æåˆ°è¿‡CRDçš„ä»£ç ä¸»è¦å®šä¹‰åœ¨**api/v1/application_types.go**æ–‡ä»¶ä¸­ï¼Œå…ˆæ‰“å¼€çœ‹ä¸€ä¸‹ç°æœ‰ä»£ç æ˜¯æ€æ ·çš„ã€‚ä¸»è¦çœ‹Specç»“æ„ï¼Œä¹Ÿå°±æ˜¯ApplicationSpecè¿™ä¸ªç»“æ„ä½“çš„å®šä¹‰ï¼š</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>type ApplicationSpec struct {<br>
Foo string <code>json:&quot;foo,omitempty&quot;</code><br>
}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">å¢åŠ å†…å®¹å¦‚ä¸‹</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>import (<br>
corev1 â€œ<a target="_blank" rel="noopener" href="http://k8s.io/api/core/v1">k8s.io/api/core/v1</a>â€<br>
metav1 â€œ<a target="_blank" rel="noopener" href="http://k8s.io/apimachinery/pkg/apis/meta/v1">k8s.io/apimachinery/pkg/apis/meta/v1</a>â€<br>
)</p>
<p>// EDIT THIS FILE!  THIS IS SCAFFOLDING FOR YOU TO OWN!<br>
// NOTE: json tags are required.  Any new fields you add must have json tags for the fields to be serialized.</p>
<p>// ApplicationSpec defines the desired state of Application<br>
type ApplicationSpec struct {<br>
Replicas int32                  <code>json:&quot;replicas,omitempty&quot;</code><br>
Template corev1.PodTemplateSpec <code>json:&quot;template,omitempty&quot;</code><br>
}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">ç„¶åä¿å­˜è°ƒç”¨å‘½ä»¤` make manifests`ï¼Œæ˜¾ç¤ºå¦‚ä¸‹</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>/root/MyOPeratorProjects/application-operator/bin/controller-gen rbac:roleName=manager-role crd webhook paths=â€œ./â€¦â€ output:crd:artifacts:config=config/crd/bases</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">çœ‹ä¸€ä¸‹è¿™ä¸¤ä¸ªæ–‡ä»¶/ç›®å½•ï¼š</span><br><span class="line"></span><br><span class="line">1. **Â·config/crd/bases/ï¼š**è¿™ä¸ªç›®å½•ä¸­æ–°å¢äº†ä¸€ä¸ª**apps.danielhu.cn_applications.yaml**æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯Applicationç±»å‹çš„CRDé…ç½®ï¼š</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<hr>
<p>apiVersion: <a target="_blank" rel="noopener" href="http://apiextensions.k8s.io/v1">apiextensions.k8s.io/v1</a><br>
kind: CustomResourceDefinition<br>
metadata:<br>
annotations:<br>
<a target="_blank" rel="noopener" href="http://controller-gen.kubebuilder.io/version:">controller-gen.kubebuilder.io/version:</a> v0.9.2<br>
creationTimestamp: null<br>
name: <a target="_blank" rel="noopener" href="http://applications.apps.danielhu.cn">applications.apps.danielhu.cn</a><br>
spec:<br>
group: <a target="_blank" rel="noopener" href="http://apps.danielhu.cn">apps.danielhu.cn</a><br>
names:<br>
kind: Application<br>
listKind: ApplicationList<br>
plural: applications<br>
singular: application<br>
scope: Namespaced<br>
versions:</p>
<ul>
<li>name: v1</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2. **Â·config/rbac/role.yaml**ï¼šè¿™é‡Œé¢å®šä¹‰çš„æ˜¯ä¸€ä¸ªClusterRoleï¼Œä»åå­—manager-roleä¸Šå¤§è‡´å¯ä»¥çŒœåˆ°ï¼Œè¿™æ˜¯åé¢Controlleréƒ¨ç½²åå°†å……å½“çš„â€œè§’è‰²â€ã€‚è¯¥æ–‡ä»¶å®šä¹‰äº†å¯¹applicationsèµ„æºçš„åˆ›å»ºã€åˆ é™¤ã€æŸ¥è¯¢ã€æ›´æ–°ç­‰æ“ä½œã€‚</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<hr>
<p>apiVersion: <a target="_blank" rel="noopener" href="http://rbac.authorization.k8s.io/v1">rbac.authorization.k8s.io/v1</a><br>
kind: ClusterRole<br>
metadata:<br>
creationTimestamp: null<br>
name: manager-role<br>
rules:</p>
<ul>
<li>apiGroups:
<ul>
<li><a target="_blank" rel="noopener" href="http://apps.danielhu.cn">apps.danielhu.cn</a><br>
resources:</li>
<li>applications<br>
verbs:</li>
<li>create</li>
<li>delete</li>
<li>get</li>
<li>list</li>
<li>patch</li>
<li>update</li>
<li>watch</li>
</ul>
</li>
<li>apiGroups:
<ul>
<li><a target="_blank" rel="noopener" href="http://apps.danielhu.cn">apps.danielhu.cn</a><br>
resources:</li>
<li>applications/finalizers<br>
verbs:</li>
<li>update</li>
</ul>
</li>
<li>apiGroups:
<ul>
<li><a target="_blank" rel="noopener" href="http://apps.danielhu.cn">apps.danielhu.cn</a><br>
resources:</li>
<li>applications/status<br>
verbs:</li>
<li>get</li>
<li>patch</li>
<li>update</li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">é€šè¿‡`make install`å‘½ä»¤æ¥å®ŒæˆCRDçš„éƒ¨ç½²è¿‡ç¨‹ï¼š</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**æŠ¥é”™**</span><br><span class="line"></span><br><span class="line">&gt; The connection to the server 192.168.62.128:6443 was refused - did you specify the right host or port?</span><br><span class="line">&gt;make: *** [install] é”™è¯¯ 1</span><br><span class="line">&gt; </span><br><span class="line">&gt; æ­¤æ—¶çªç„¶å‘ç°K8sé›†ç¾¤ä¸ç®¡ç”¨äº†ï¼ˆä¸ªäººç‰¹å¼‚æ€§åŸå› ï¼‰ï¼è§£å†³é—®é¢˜çš„è¿‡ç¨‹è§â€é›†ç¾¤å‡ºé—®é¢˜â€œæ–‡ç« ã€‚</span><br><span class="line">&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">æˆåŠŸåè¾“å‡ºä»¥ä¸‹å†…å®¹</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>[root@master application-operator]# make install<br>
test -s /root/MyOPeratorProjects/application-operator/bin/controller-gen || GOBIN=/root/MyOPeratorProjects/application-operator/bin go install <a target="_blank" rel="noopener" href="http://sigs.k8s.io/controller-tools/cmd/controller-gen@v0.9.2">sigs.k8s.io/controller-tools/cmd/controller-gen@v0.9.2</a><br>
/root/MyOPeratorProjects/application-operator/bin/controller-gen rbac:roleName=manager-role crd webhook paths=â€œ./â€¦â€ output:crd:artifacts:config=config/crd/bases<br>
/root/MyOPeratorProjects/application-operator/bin/kustomize build config/crd | kubectl apply -f -<br>
<a target="_blank" rel="noopener" href="http://customresourcedefinition.apiextensions.k8s.io/applications.apps.danielhu.cn">customresourcedefinition.apiextensions.k8s.io/applications.apps.danielhu.cn</a> created</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">æ‰§è¡Œå®Œmake installåï¼ŒCRDå°±éƒ¨ç½²åˆ°é›†ç¾¤ä¸­äº†ï¼Œè¿™æ—¶å¯ä»¥é€šè¿‡kubectlæŸ¥è¯¢åˆšæ‰åˆ›å»ºçš„CRDã€‚</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>[root@master application-operator]# kubectl get crd<br>
NAME                            CREATED AT<br>
<a target="_blank" rel="noopener" href="http://applications.apps.danielhu.cn">applications.apps.danielhu.cn</a>   2023-04-26T06:31:35Z</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">å¯ä»¥çœ‹åˆ°ï¼Œapplications.apps.danielhu.cnè¿™ä¸ªCRDå·²ç»å­˜åœ¨äº†ã€‚è¿™æ—¶å°±åƒæŸ¥è¯¢Deploymentæ—¶å¯ä»¥ç”¨kubectl get deploymentä¸€æ ·ï¼Œå¯ä»¥é€šè¿‡kubectl get applicationæ¥æŸ¥è¯¢åˆšæ‰è‡ªå®šä¹‰çš„èµ„æºã€‚è¿™é‡Œçš„æŠ¥é”™ä¿¡æ¯æ˜¯æ²¡æ‰¾åˆ°èµ„æºï¼Œè€Œä¸æ˜¯â€œerror:the server doesn&#x27;t have a resource type&quot;application&quot;â€ã€‚æ¢è¨€ä¹‹ï¼Œæ­¤æ—¶kube-apiserverå·²ç»èƒ½è¯†åˆ«è¿™ç§èµ„æºäº†ã€‚</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**å›é¡¾ä¸€ä¸‹ï¼Œæˆ‘ä»¬ä¾æ¬¡åšçš„äº‹æƒ…ï¼š**</span><br><span class="line"></span><br><span class="line">- kubebuilder create api --group xxx --version v1 --king Application</span><br><span class="line">  - è¿™æ—¶å€™åœ¨æç¤ºä¸‹åˆ›å»ºäº†èµ„æºå’Œcontroller</span><br><span class="line">  - åˆ›å»ºäº†apiæ–‡ä»¶å¤¹ä»¥åŠå˜æ›´äº†main.goç­‰</span><br><span class="line">- api/v1/application_types.goæ–‡ä»¶ä¸­importé‡ŒåŠ äº†corev1ï¼Œmetav1ï¼ŒApplicationSpectä¸­åŠ äº†replicaå’Œtemplateå£°æ˜å‰¯æœ¬çš„æ•°é‡å’Œæ¨¡æ¿çš„é…ç½®</span><br><span class="line">- make manifestså‘½ä»¤ç”ŸæˆCRï¼ˆconfig/rbac/role.yamlï¼ŒControlleréƒ¨ç½²åå°†å……å½“çš„â€œè§’è‰²â€ã€‚ï¼‰å’ŒCRDé…ç½®ï¼ˆconfig/crd/bases/apps.danielhu.cn_applications.yamlï¼‰ã€‚</span><br><span class="line">- é€šè¿‡make installå‘½ä»¤æ¥å®ŒæˆCRDçš„éƒ¨ç½²è¿‡ç¨‹ã€‚</span><br><span class="line">  - å¯ä»¥getåˆ°crdäº†ï¼Œè¿™é‡Œcrdå°±åƒæ˜¯development</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 5. CRéƒ¨ç½²</span><br><span class="line"></span><br><span class="line">å’Œå†™ä¸€ä¸ªDeploymentèµ„æºé…ç½®å¯¹åº”çš„Ã—Ã—Ã—.yamlä¸€æ ·ï¼Œåˆ›å»ºApplicationåŒæ ·éœ€è¦ä¸€ä¸ªYAMLæ–‡ä»¶ã€‚æˆ‘ä»¬åœ¨å‰é¢æåˆ°è¿‡åœ¨config/samplesä¸‹æœ‰ä¸€ä¸ªapps_v1_application.yamlï¼Œå…¶ä¸­å·²ç»æœ‰ä¸€äº›é»˜è®¤é…ç½®é¡¹äº†ï¼Œæˆ‘ä»¬ç¨å¾®ä¿®æ”¹ä¸€ä¸‹ï¼ŒåŠ ä¸Šè‡ªå®šä¹‰çš„å±æ€§ï¼š</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>apiVersion: <a target="_blank" rel="noopener" href="http://apps.danielhu.cn/v1">apps.danielhu.cn/v1</a><br>
kind: Application<br>
metadata:<br>
name: application-sample<br>
namespace: default<br>
labels:<br>
app: nginx<br>
spec:<br>
replicas: 3<br>
template:<br>
spec:<br>
containers:<br>
- name: nginx<br>
image: nginx:1.14.2<br>
ports:<br>
- containerPort: 80</p>
<h1>TODO(user): Add fields here</h1>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">applyä¸€ä¸‹</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>[root@master application-operator]# kubectl apply -f config/samples/apps_v1<br>
<a target="_blank" rel="noopener" href="http://application.apps.danielhu.cn/application-sample">application.apps.danielhu.cn/application-sample</a> cr</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">æŸ¥çœ‹åˆšæ‰åˆ›å»ºçš„application</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>[root@master application-operator]# kubectl get application<br>
NAME                 AGE<br>
application-sample   99s</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ä¸€ä¸ªApplicationç±»å‹çš„application-sampleå®ä¾‹åˆ›å»ºå‡ºæ¥äº†ï¼Œå…¶ä¸­åŒ…å«è‡ªå®šä¹‰çš„æ‰€æœ‰å­—æ®µã€‚ä½†æ˜¯è¿™æ—¶å¹¶ä¸ä¼šæœ‰Podè¢«è‡ªåŠ¨åˆ›å»ºå‡ºæ¥ï¼Œå› ä¸ºè¿˜æ²¡æœ‰å®ç°ç›¸åº”çš„æ§åˆ¶å™¨é€»è¾‘ã€‚</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 6. Controllerå®ç°</span><br><span class="line"></span><br><span class="line">ç°åœ¨å·²ç»æœ‰äº†CRï¼Œè¯¥å®ç°Controlleré€»è¾‘å»åˆ›å»ºPodäº†ã€‚åœ¨controllers/application_controller.goä¸­çš„Reconcile()æ–¹æ³•å†…æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>func (r *ApplicationReconciler) Reconcile(ctx context.Context, req ctrl.Request) (ctrl.Result, error) {<br>
l := log.FromContext(ctx)</p>
<pre><code>// get the Application
app := &amp;dappsv1.Application&#123;&#125;
if err := r.Get(ctx, req.NamespacedName, app); err != nil &#123;
	if errors.IsNotFound(err) &#123;
		l.Info(&quot;the Application is not found&quot;)
		return ctrl.Result&#123;&#125;, nil
	&#125;
	l.Error(err, &quot;failed to get the Application&quot;)
	return ctrl.Result&#123;RequeueAfter: 1 * time.Minute&#125;, err
&#125;

// create pods
for i := 0; i &lt; int(app.Spec.Replicas); i++ &#123;
	pod := &amp;corev1.Pod&#123;
		ObjectMeta: metav1.ObjectMeta&#123;
			Name:      fmt.Sprintf(&quot;%s-%d&quot;, app.Name, i),
			Namespace: app.Namespace,
			Labels:    app.Labels,
		&#125;,
		Spec: app.Spec.Template.Spec,
	&#125;

	if err := r.Create(ctx, pod); err != nil &#123;
		l.Error(err, &quot;failed to create Pod&quot;)
		return ctrl.Result&#123;RequeueAfter: 1 * time.Minute&#125;, err
	&#125;
	l.Info(fmt.Sprintf(&quot;the Pod (%s) has created&quot;, pod.Name))
&#125;

l.Info(&quot;all pods has created&quot;)
return ctrl.Result&#123;&#125;, nil
</code></pre>
<p>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">importéƒ¨åˆ†</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>import (<br>
â€œcontextâ€<br>
â€œfmtâ€<br>
â€œtimeâ€</p>
<pre><code>corev1 &quot;k8s.io/api/core/v1&quot;
&quot;k8s.io/apimachinery/pkg/api/errors&quot;
metav1 &quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;
&quot;k8s.io/apimachinery/pkg/runtime&quot;
ctrl &quot;sigs.k8s.io/controller-runtime&quot;
&quot;sigs.k8s.io/controller-runtime/pkg/client&quot;
&quot;sigs.k8s.io/controller-runtime/pkg/log&quot;

dappsv1 &quot;github.com/daniel-hutao/application-operator/api/v1&quot;
</code></pre>
<p>)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">è¿™é‡Œæˆ‘ä»¬æŠŠè‡ªå·±çš„api/v1æ‰“åŒ…å¹¶ä½¿ç”¨åˆ«ådappsv1ï¼Œé¿å…å’Œk8s.io/api/apps/v1åŒ…äº§ç”Ÿæ··æ·†ã€‚</span><br><span class="line"></span><br><span class="line">ä»£ç è§£é‡Šï¼š</span><br><span class="line"></span><br><span class="line">![go_explain](/images/go_explain.png)</span><br><span class="line"></span><br><span class="line">å¯åŠ¨controllerï¼šæ‰§è¡Œmake run</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**æŠ¥é”™**</span><br><span class="line"></span><br><span class="line">&gt; æ­¤æ—¶ä¸å‡ºæ„å¤–çš„åˆå‡ºé—®é¢˜äº†ï¼Œè¾“å‡ºä¸€æ®µæ•°æ®åé¡µé¢åœæ­¢ä¸åŠ¨äº†ï¼Œè¿™æ—¶å€™ctrl+cé€€å‡ºï¼Œæ˜¾ç¤º</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>1.682495037273707e+09   INFO    All workers finished    {â€œcontrollerâ€: â€œapplicationâ€, â€œcontrollerGroupâ€: â€œ<a target="_blank" rel="noopener" href="http://apps.danielhu.cn">apps.danielhu.cn</a>â€, â€œcontrollerKindâ€: â€œApplicationâ€}<br>
1.6824950372737312e+09  INFO    Stopping and waiting for caches<br>
1.6824950372738228e+09  INFO    Stopping and waiting for webhooks<br>
1.6824950372738297e+09  INFO    Wait completed, proceeding to shutdown the manager<br>
make: *** [run] é”™è¯¯ 1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ä¸çŸ¥é“ä¸ºå•¥ï¼ŒæŸ¥çœ‹podä¿¡æ¯ï¼Œå‘ç°ä¸‰ä¸ªpodéƒ½åœ¨pending</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>root@master application-operator]# kubectl get pod<br>
NAME                   READY   STATUS    RESTARTS   AGE<br>
application-sample-0   0/1     Pending   0          7m44s<br>
application-sample-1   0/1     Pending   0          7m44s<br>
application-sample-2   0/1     Pending   0          7m44s</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">è¿™æ—¶å€™è‚¯å®šæ˜¯describe podï¼Œè¾“å‡ºæœ€åçš„ä¿¡æ¯å¦‚ä¸‹</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Events:<br>
Type     Reason            Age                  From               Message</p>
<hr>
<p>Warning  FailedScheduling  65s (x6 over 8m33s)  default-scheduler  0/3 nodes are available: 3 node(s) had taints that the pod didnâ€™t tolerate.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">è¯´ä¸‰ä¸ªèŠ‚ç‚¹éƒ½æœ‰æ±¡ç‚¹ï¼Œmasterè‚¯å®šæ˜¯æœ‰æ±¡ç‚¹çš„ï¼Œå¦å¤–ä¸¤ä¸ªæ€ä¹ˆå›äº‹ï¼ŸæŸ¥çœ‹nodeï¼Œå‘ç°</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>[root@master application-operator]# kubectl get nodes<br>
NAME     STATUS     ROLES    AGE     VERSION<br>
master   Ready      master   5d16h   v1.17.4<br>
node1    NotReady   <none>   5d15h   v1.17.4<br>
node2    NotReady   <none>   5d15h   v1.17.4</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ä¸¤ä¸ªèŠ‚ç‚¹ç«Ÿç„¶æ²¡è·‘èµ·æ¥ï¼Ÿdescribe node1å‘ç°æç¤ºNetworkUnavailable</span><br><span class="line"></span><br><span class="line">ping Node1å‘ç°ä¸å¯è¾¾</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>[root@master application-operator]# ping node1<br>
PING node1 (192.168.62.134) 56(84) bytes of data.<br>
From master (192.168.62.128) icmp_seq=10 Destination Host Unreachable</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ä¸çŸ¥é“ä¸ºå•¥ç½‘æ–­äº†node1å¤±å»äº†ipåœ°å€ï¼Œæˆ‘è¿›å…¥node1é‡å¯ç½‘è·¯æœåŠ¡ï¼Œç½‘ç»œå¥½äº†ã€‚</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**æŠ¥é”™ï¼š**</span><br><span class="line"></span><br><span class="line">1.6824959595997632e+09  ERROR   setup   unable to start manager &#123;&quot;error&quot;: &quot;error listening on :8080: listen tcp :8080: bind: address already in use&quot;&#125;</span><br><span class="line"></span><br><span class="line">å› ä¸ºè¿™ä¸ªç«¯å£å·²ç»è¢«æˆ‘åˆ›å»ºå‡ºæ¥çš„podå äº†ï¼Œä¸ç”¨å†åˆ›å»ºæ–°çš„äº†ã€‚</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">æ­¤æ—¶kubectl get podså¯ä»¥æŸ¥å‡ºä¸‰ä¸ªä¹‹å‰éƒ¨ç½²çš„podå·²ç»åœ¨è¿è¡Œäº†ã€‚</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</blockquote>
<p>[root@master ~]# kubectl get pods<br>
NAME                   READY   STATUS    RESTARTS   AGE<br>
application-sample-0   1/1     Running   0          22h<br>
application-sample-1   1/1     Running   0          22h<br>
application-sample-2   1/1     Running   0          22h</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 7. Controlleréƒ¨ç½²</span><br><span class="line"></span><br><span class="line">å‰é¢æˆ‘ä»¬éƒ¨ç½²äº†ä¸€ä¸ªApplicationç±»å‹çš„èµ„æºå¯¹è±¡å®ä¾‹ï¼Œä¹Ÿè¿è¡ŒControllerçœ‹åˆ°äº†ç›¸åº”å‰¯æœ¬æ•°çš„Podè¢«åˆ›å»ºå‡ºæ¥ã€‚ç°åœ¨æˆ‘ä»¬è¿›ä¸€æ­¥æ¨¡æ‹ŸOperatorå®é™…ä½¿ç”¨æ—¶çš„éƒ¨ç½²æ–¹å¼ï¼ŒæŠŠControlleræ‰“åŒ…åç”¨å®¹å™¨åŒ–æ–¹å¼éƒ¨ç½²åˆ°Kubernetesé›†ç¾¤ç¯å¢ƒä¸­ï¼š</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>make docker-build IMG=application-operator:v0.0.1<br>
kind load docker-image application-operator:v0.0.1 --name dev    no<br>
make deploy IMG=application-operator:v0.0.1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">å› ä¸ºæˆ‘çš„K8sä¸æ˜¯ä½¿ç”¨kindï¼Œæ‰€ä»¥çœæ‰äº†ç¬¬äºŒæ­¥ï¼Œæœ€ç»ˆæŸ¥åˆ°äº†éƒ¨ç½²çš„Pod</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>[root@master application-operator]# kubectl get pod -n application-operator-system<br>
NAME                                                       READY   STATUS         RESTARTS   AGE<br>
application-operator-controller-manager-5b754fc8bd-z28z9   1/2     ErrImagePull   0          2m46s</p>
<pre><code>
è‡³æ­¤ï¼Œå°±å®ç°äº†ä¸€ä¸ªéå¸¸ç®€å•çš„Operatorç¨‹åºçš„å¼€å‘ã€ç¼–è¯‘æ„å»ºã€æ‰“åŒ…ã€éƒ¨ç½²ç­‰æµç¨‹ã€‚å½“ç„¶ï¼Œå¦‚æœå‰é¢æ‰§è¡Œmake runå¯åŠ¨äº†æ§åˆ¶å™¨åˆ›å»ºå‡ºæ¥çš„3ä¸ªPodæ²¡æœ‰è¢«åˆ é™¤ï¼Œè¿™æ—¶å†æ¬¡éƒ¨ç½²ä¸€ä¸ªOperatoræ§åˆ¶å™¨ï¼Œæ—¥å¿—é‡Œè‚¯å®šä¼šæœ‰æŠ¥é”™ä¿¡æ¯çš„ï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰å®ç°Podå­˜åœ¨æ ¡éªŒç­‰ä»£ç é€»è¾‘ã€‚ä¸è¿‡è¿™ä¸æ˜¯é‡ç‚¹ï¼Œæœ‰æ²¡æœ‰è¿™äº›é”™è¯¯ï¼Œæˆ‘ä»¬çš„Demoç¨‹åºéƒ½ç®—èµ°å®Œäº†ã€‚åˆ°è¿™é‡Œï¼Œå¤§å®¶åŸºæœ¬ä½“éªŒäº†ä¸€éOperatorçš„å¿«é€Ÿå¼€å‘æµç¨‹ã€‚



### 8. èµ„æºæ¸…ç†

å‰é¢æˆ‘ä»¬é€šè¿‡å‡ ä¸ªæ­¥éª¤åˆ†åˆ«éƒ¨ç½²äº†CRDã€CRå’ŒControllerï¼Œè¿™æ—¶ç¯å¢ƒä¸­æ–°å¢çš„èµ„æºä¸å°‘ï¼ˆå„ç§rbacç›¸å…³çš„ã€éƒ¨ç½²ç›¸å…³çš„èµ„æºï¼‰ï¼Œå¦‚æœè¿™äº›èµ„æºéƒ½ç”¨kubectlä¸€ä¸ªä¸€ä¸ªæ¥æ¸…ç†ï¼Œè¿˜æ˜¯å¾ˆç—›è‹¦çš„ã€‚åŒæ ·ï¼Œæ¸…ç†çš„æ­¥éª¤ä¹Ÿå¯ä»¥é€šè¿‡Makefileæ¥å®ç°ï¼š

å¸è½½Controllerï¼š`make undeploy`

å¸è½½CRDï¼š`make uninstall`



### 9.æ€»ç»“ä¸ç†è§£

![](/images/summarize_helloworld.png)



### 10. å—é”¤æ„Ÿæ‚Ÿ

åœ¨åšçš„è¿‡ç¨‹ä¸­ä¸€æ¬¡æ¬¡çš„é‡åˆ°å„ç§é—®é¢˜ï¼Œç¯å¢ƒã€ç½‘ç»œã€ç‰ˆæœ¬åŒ¹é…ã€æ•²é”™å‘½ä»¤æ‰¾åŠå¤©ã€k8sè«åå‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬ã€æ•™ç¨‹æœ‰è¯¯......å„ç§é”™è¯¯ï¼Œæ— ä¸€ä¸è®©æˆ‘å¿ƒå¤´ç„¦ç¼æ”¥ç´§æ‹³å¤´ç«å†’ä¸‰ä¸ˆï¼Œå¿ƒç°æ„å†·ã€‚

ä¸æ–­é‡åˆ°é—®é¢˜ï¼Œä¸æ–­è§£å†³é—®é¢˜ï¼Œè¿™ä¸ªè¿‡ç¨‹å¾ˆç—›è‹¦ï¼Œä½†æ˜¯é—®é¢˜è§£å†³çš„é‚£ä¸€åˆ»å¾ˆæœ‰æˆå°±æ„Ÿã€‚

ç›¸ä¿¡åªè¦ä¸æ”¾å¼ƒï¼Œåœ¨è¢«å„ç§â€œé—®é¢˜â€æ´—ç¤¼çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬çš„èƒ½åŠ›ä¼šè¶Šæ¥è¶Šå¼ºã€‚





&gt; Notesï¼š
&gt;
&gt; ä»¥ä¸Šå†…å®¹å‡ä¸ºä¸ªäººå­¦ä¹ è¿‡ç¨‹ä¸­çš„ç†è§£ï¼Œç†è§£å’Œæ€»ç»“å¯èƒ½æœ‰åå·®ã€‚æ–‡ç« å†…å®¹ä¼šéšç€å­¦ä¹ è¿‡ç¨‹ä¸æ–­ä¿®æ”¹å®Œå–„ã€‚
&gt;
&gt; å¦‚æœä»¥ä¸Šæœ‰é”™è¯¯æ¬¢è¿æŒ‡å‡ºã€‚
&gt;
&gt; æœ¬æ¬¡å®éªŒæ¡ˆä¾‹æ¥è‡ª èƒ¡æ¶› https://www.danielhu.cn/categories/

</code></pre>

</div>

<!-- post-guide -->

    <div class="post-guide">
        <div class="item left">
            
              <a href="/2023/04/26/7.%20%E3%80%90%E6%95%85%E9%9A%9C%E3%80%91K8s%E7%BB%84%E4%BB%B6%E7%89%88%E6%9C%AC%E5%87%BA%E9%97%AE%E9%A2%98/">
                  <i class="fa fa-angle-left" aria-hidden="true"></i>
                  ã€æ•…éšœã€‘K8sç»„ä»¶ç‰ˆæœ¬å‡ºé—®é¢˜
              </a>
            
        </div>
        <div class="item right">
            
              <a href="/2023/04/25/5.%20%E4%BB%80%E4%B9%88%E6%98%AFOperator/">
                ä»€ä¹ˆæ˜¯Operator
                <i class="fa fa-angle-right" aria-hidden="true"></i>
              </a>
            
        </div>
    </div>


<!-- comment - giscus -->


<!-- comment - valine -->


<script>
	
	
</script>
	</div>
	<div id="footer">
	<p>
	Â©<span id="footerYear-start"></span>-<span id="footerYear-end"></span>
	<a href="/">å€ªå…‹æ¾</a> 
	
	
	<br>
	Theme <a href="//github.com/wujun234/hexo-theme-tree" target="_blank">Tree</a>
	by <a href="//github.com/wujun234" target="_blank">WuJun</a>
	Powered by <a href="//hexo.io" target="_blank">Hexo</a>
	</p>
</div>


<script type="text/javascript">
	document.getElementById('footerYear-start').innerHTML = new Date().getFullYear() + '';
</script>

<script type="text/javascript">
	document.getElementById('footerYear-end').innerHTML = new Date().getFullYear() + '';
</script>

	<button id="totop-toggle" class="toggle"><i class="fa fa-angle-double-up" aria-hidden="true"></i></button>
</body>
</html>