<!DOCTYPE html>
<html lang="en">

<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
	
	<!-- title -->
	
	<title>
	
		å°è¯•å¼€å‘ä¸€ä¸ªç®€å•çš„Podç®¡ç†æ§åˆ¶å™¨ | 
	 
	Hexo
	</title>
	
	<!-- keywords,description -->
	 

	<!-- favicon -->
	
	<link rel="shortcut icon" href="/favicon.ico">
	


	<!-- search -->
	<script>
		var searchEngine = "https://www.google.com/search?q=";
		if(typeof searchEngine == "undefined" || searchEngine == null || searchEngine == ""){
			searchEngine = "https://www.google.com/search?q=";
		}
		var homeHost = "";
		if(typeof homeHost == "undefined" || homeHost == null || homeHost == ""){
			homeHost = window.location.host;
		}
	</script>


	
<link rel="stylesheet" href="/css/main.css">

	
<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css">

	
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.17.1/build/styles/darcula.min.css">

	
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">


	
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>

	
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>

	
<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.17.1/build/highlight.min.js"></script>

	
<script src="https://cdn.jsdelivr.net/npm/jquery-pjax@2.0.1/jquery.pjax.min.js"></script>

	
<script src="/js/main.js"></script>


	
		
<script src="https://cdn.jsdelivr.net/npm/leancloud-storage/dist/av-min.js"></script>

		
<script src="https://cdn.jsdelivr.net/npm/valine@v1.5.1/dist/Valine.min.js"></script>

	
	

<meta name="generator" content="Hexo 6.3.0"></head>

<body>
	<header id="header">
    <a id="title" href="/" class="logo">Hexo</a>

	<ul id="menu">
    

    

    

    
      
      
        <li class="menu-item">
          <a href='https://github.com/NikeSong' class="menu-item-link" target="_blank">
            Nicolson
          </a>
        </li>
      
        <li class="menu-item">
          <a href='https://github.com/NikeSong' class="menu-item-link" target="_blank">
            Nicolson
          </a>
        </li>
      
    
  
    
      <li class="menu-item">
        <a href='https://github.com/NikeSong' class="menu-item-link" target="_blank">
          <i class="fa fa-github fa-2x"></i>
        </a>
      </li>
    
	</ul>
</header>

	
<div id="sidebar">
	<button id="sidebar-toggle" class="toggle" ><i class="fa fa-arrow-right " aria-hidden="true"></i></button>
	
	<div id="site-toc">
		<input id="search-input" class="search-input" type="search" placeholder="æŒ‰å›è½¦å…¨ç«™æœç´¢">
		<div id="tree">
			

			
							<ul>
								<li class="file">
									<a href="/2023/04/23/1.%20Kubernetes%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/">
                     
										    KubernetesåŸºæœ¬ç»“æ„
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/04/28/10.%20%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Client-go%E5%AE%9E%E7%8E%B0%E6%9C%BA%E7%90%86/">
                     
										    æ·±å…¥å­¦ä¹ Client-Goå®ç°æœºç†ï¼ˆè¿›è¡Œä¸­ï¼‰
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/04/27/11.%20Operator%E5%BC%80%E5%8F%91%E8%BF%9B%E9%98%B6/">
                     
										    Operatorå¼€å‘è¿›é˜¶ï¼ˆè¿›è¡Œä¸­ï¼‰
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/04/28/12.%20Deployment%20Controller%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">
                     
										    Deployment Controlleræºç åˆ†æ(æœªå¼€å§‹)
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/04/23/2.%20Pod%E7%BB%86%E8%8A%82%E5%88%86%E6%9E%90/">
                     
										    Podç»†èŠ‚åˆ†æ
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/04/24/3.%20K8s%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2/">
                     
										    K8sæœåŠ¡æš´éœ²
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/04/24/4.%20%E6%8E%A2%E7%A7%98Docker%E5%AE%B9%E5%99%A8%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/">
                     
										    æ¢ç§˜Dockerå®¹å™¨çš„å®ç°åŸç†ï¼ˆè¿›è¡Œä¸­ï¼‰
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/04/25/5.%20%E4%BB%80%E4%B9%88%E6%98%AFOperator/">
                     
										    ä»€ä¹ˆæ˜¯Operator
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file active">
									<a href="/2023/04/25/6.%20%E5%B0%9D%E8%AF%95%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84Pod%E7%AE%A1%E7%90%86%E6%8E%A7%E5%88%B6%E5%99%A8/">
                     
										    å°è¯•å¼€å‘ä¸€ä¸ªç®€å•çš„Podç®¡ç†æ§åˆ¶å™¨
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/04/26/7.%20%E3%80%90%E6%95%85%E9%9A%9C%E3%80%91K8s%E7%BB%84%E4%BB%B6%E7%89%88%E6%9C%AC%E5%87%BA%E9%97%AE%E9%A2%98/">
                     
										    ã€æ•…éšœã€‘K8sç»„ä»¶ç‰ˆæœ¬å‡ºé—®é¢˜
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/04/27/7.5.%20%E3%80%90%E6%95%85%E9%9A%9C%E3%80%91%E4%B8%80%E5%8F%B0%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%99%BB%E9%99%86%E4%B8%8D%E8%BF%9B%E5%8E%BB%E4%BA%86/">
                     
										    ã€æ•…éšœã€‘ä¸€å°è™šæ‹Ÿæœºç™»é™†ä¸è¿›å»äº†
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/04/27/8.%20k8s%20api%E5%AD%A6%E4%B9%A0/">
                     
										    curlæ–¹å¼å’Œrawæ–¹å¼è®¿é—®api server
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/04/28/9.%20GVK-%E7%BB%84%E3%80%81%E7%89%88%E6%9C%AC%E5%92%8C%E7%B1%BB%E5%9E%8B/">
                     
										    GVKå’ŒGVR
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
		</div>
	</div>
</div>

	<!-- å¼•å…¥æ­£æ–‡ -->
	<div id="content">
		<h1 id="article-title">
	å°è¯•å¼€å‘ä¸€ä¸ªç®€å•çš„Podç®¡ç†æ§åˆ¶å™¨
</h1>

<!-- meta -->
<div class="article-meta">
	

	<span>John Doe</span>
	<span>2023-04-25 14:58:00</span>

  <div id="article-categories">
    
		  <span>Categoriesï¼š</span>
      
          
              <span>
                  <i class="fa fa-folder" aria-hidden="true">
                  <a href="/categories/Kuberneteså­¦ä¹ ç¬”è®°/">Kuberneteså­¦ä¹ ç¬”è®°</a>
                  </i>
                
              </span>
          
      
    

    
		    <span>Tagsï¼š</span>
        
    
  </div>

</div>

<!-- content -->
<div id="article-content">
	<h2 id="å¼€å‘ä¸€ä¸ªpodç®¡ç†æ§åˆ¶å™¨"><a class="markdownIt-Anchor" href="#å¼€å‘ä¸€ä¸ªpodç®¡ç†æ§åˆ¶å™¨"></a> å¼€å‘ä¸€ä¸ªPodç®¡ç†æ§åˆ¶å™¨</h2>
<h3 id="1-å¼€å‘ç›®æ ‡"><a class="markdownIt-Anchor" href="#1-å¼€å‘ç›®æ ‡"></a> 1. å¼€å‘ç›®æ ‡</h3>
<p>ç±»æ¯”äºDeploymentå¯ä»¥ç®¡ç†Podï¼Œæˆ‘ä»¬ç°åœ¨å°è¯•å¼€å‘ä¸€ä¸ªç®€å•çš„Podç®¡ç†æ§åˆ¶å™¨Application Operatorï¼Œä½†æ˜¯æš‚æ—¶åªæ”¯æŒPodå‰¯æœ¬æ•°çš„ç®¡ç†ã€‚</p>
<p>æˆ‘ä»¬è¦é€šè¿‡ä¸€ä¸ªApplicationç±»å‹æ¥å®šä¹‰ä¸€ä¸ªè‡ªå·±çš„èµ„æºå¯¹è±¡ï¼Œç„¶ååœ¨æ§åˆ¶å™¨ä¸­è·å–è¿™ä¸ªèµ„æºå¯¹è±¡çš„è¯¦ç»†é…ç½®ï¼Œæ¥ç€æ ¹æ®å®ƒçš„é…ç½®å»åˆ›å»ºç›¸åº”æ•°é‡çš„Podï¼Œå°±åƒDe-ploymenté‚£æ ·å·¥ä½œã€‚å½“ç„¶ï¼Œä¸ºäº†é¿å…Demoé¡¹ç›®è¿‡äºå¤æ‚ï¼Œè¿™é‡Œä¸å»è€ƒè™‘è¿‡å¤šçš„å¼‚å¸¸å¤„ç†ã€ç¨‹åºå¥å£®æ€§ã€ä¸šåŠ¡é€»è¾‘å®Œå¤‡ç­‰ã€‚</p>
<p><img src="../images/application_operator_function.png" alt="that's the way" /></p>
<h3 id="2-åˆå§‹åŒ–é¡¹ç›®"><a class="markdownIt-Anchor" href="#2-åˆå§‹åŒ–é¡¹ç›®"></a> 2. åˆå§‹åŒ–é¡¹ç›®</h3>
<p>åˆ›å»ºæ–‡ä»¶å¤¹ç»„ï¼Œåˆ›å»ºæ–‡ä»¶å¤¹ï¼Œåœ¨é‡Œé¢æ‰§è¡Œä»¥ä¸‹è¯­å¥</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubebuilder init --domain=danielhu.cn --repo=github.com/daniel-hutao/application-operator --owner Daniel.Hu</span><br></pre></td></tr></table></figure>
<p>å‚æ•°å«ä¹‰</p>
<ul>
<li><code>â€“-domain lailin.xyz</code> æˆ‘ä»¬çš„é¡¹ç›®çš„åŸŸå</li>
<li><code>--repo xxx</code> æ˜¯ä»“åº“åœ°å€ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ <code>go mode</code> ä¸­çš„ <code>repo</code> åœ°å€</li>
</ul>
<p><strong>æŠ¥é”™1ï¼š</strong></p>
<blockquote>
<p>å¦‚æœä½  <code>golang</code> ç‰ˆæœ¬è¿‡ä½æˆ–è€…è¿‡é«˜éƒ½æœ‰å¯èƒ½å‡ºç°ä¸‹æ–¹çš„é”™è¯¯ä¿¡æ¯ï¼Œæˆ‘è¿™é‡Œæ˜¯å› ä¸ºä½¿ç”¨çš„ <code>1.16</code> ç‰ˆæœ¬å¤ªé«˜äº†</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2021/04/25 20:47:14 failed to initialize project: unable to run pre-scaffold tasks of &quot;base.go.kubebuilder.io/v3&quot;: go version &#x27;go1.16&#x27; is incompatible because &#x27;requires 1.13 &lt;= version &lt; 1.16&#x27;. You can skip this check using the --skip-go-version-check flag</span><br></pre></td></tr></table></figure>
<p>è¿™ç§æƒ…å†µä¸‹å¯ä»¥æ·»åŠ  <code>--skip-go-version-check</code> å¿½ç•¥è¿™ä¸ªé”™è¯¯</p>
</blockquote>
<p><strong>æŠ¥é”™2ï¼š</strong></p>
<blockquote>
<p>æ‰¾ä¸åˆ°go</p>
<p>export PATH=$PATH:/usr/local/go/bin</p>
<p>ä¸Šè¿°æ–¹æ³•çš„PATH åœ¨ç»ˆç«¯å…³é—­ åå°±ä¼šæ¶ˆå¤±ã€‚æ‰€ä»¥è¿˜æ˜¯å»ºè®®é€šè¿‡ç¼–è¾‘/etc/profileæ¥æ”¹PATHï¼Œä¹Ÿå¯ä»¥ä¿®æ”¹å®¶ç›®å½•ä¸‹çš„.bashrc(å³ï¼š~/.bashrc)ã€‚</p>
<blockquote>
<p>ä¿®æ”¹ç¯å¢ƒå˜é‡</p>
<ul>
<li>
<pre class="highlight"><code class="shell">vi /etc/profile
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- æœ€ä¸‹é¢åŠ ä¸Šï¼š</span><br><span class="line"></span><br><span class="line">  ```shell</span><br><span class="line">  export PATH=$PATH:/usr/local/xxx/bin</span><br></pre></td></tr></table></figure>

</code></pre>
</li>
<li>
<p>åˆ·æ–°ç¯å¢ƒå˜é‡</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>
</li>
</ul>
</blockquote>
</blockquote>
<p><strong>æŠ¥é”™3ï¼š</strong></p>
<blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error: failed to initialize project: unable to scaffold with &quot;base.go.kubebuilder.io/ve&quot;: exit status l</span><br></pre></td></tr></table></figure>
<p>Goçš„ç‰ˆæœ¬ä¸åŒ¹é…ï¼Œæˆ‘ç”¨çš„æ˜¯1.17.6ï¼Œæ”¹ä¸º1.10.4ï¼Œçœ‹åˆ°åˆ«äººç”¨1.18.5æ”¹ä¸º1.18.5</p>
<blockquote>
<p>ä»ç„¶æŠ¥é”™ï¼Œç ”ç©¶ä¸€ä¸‹åˆ + ä¸€æ™šä¸Šçœ‹äº†å„ç§æ–‡æ¡£å’Œissueä»ç„¶è§£å†³ä¸äº†ï¼Œå¿ƒå¦‚æ­»ç°æ¬²å“­æ— æ³ªï¼Œæ­£å‡†å¤‡æ˜å¤©æŠŠè™šæ‹Ÿæœºä»å¤´åˆ°å°¾éƒ½æ¢æˆå’Œæ•™ç¨‹åŒæ ·çš„ç‰ˆæœ¬æ—¶è·Ÿå®¤å‹æŠ±æ€¨èµ·è¿™ä¸ªé—®é¢˜ã€‚</p>
<p>ä»–å¾ˆæ„Ÿå…´è¶£ï¼Œè¶´æˆ‘ç”µè„‘æ—è¾¹çœ‹é—®é¢˜ï¼Œæˆ‘å½“æ—¶å›å®¿èˆç”¨çš„æ˜¯è‡ªå·±ç¬”è®°æœ¬è¿œç¨‹ç™»é™†å®éªŒå®¤ç”µè„‘ï¼Œå®éªŒå®¤ç”µè„‘å¼€è™šæ‹Ÿæœº+vpnï¼Œä¸€æ‰“å¼€vpnæ•´ä¸ªç”»é¢å¡æˆPPTï¼Œä½†æ˜¯å°±åœ¨è¿™æ ·çš„æç«¯æ¶åŠ£çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åˆæ¢è°·æ­Œæœç´¢çœ‹äº†å‡ ä¸ªæ–‡ç« ï¼Œä»æœªè§£å†³ã€‚</p>
<p>åæ¥ä»–è¯´ä½ æŠŠè¿™ä¸ªæŠ¥é”™ä¿¡æ¯å‘ç»™æˆ‘æˆ‘å†çœ‹çœ‹ï¼Œä»–æ”¶åˆ°åç¬¬ä¸€æ—¶é—´æ‰“å¼€äº†ChatGPTğŸ˜‚GPTè¯´å¯èƒ½æ˜¯GOBINç¯å¢ƒæ²¡é…å¥½ï¼Œæˆ‘åˆæ£€æŸ¥äº†ç¯å¢ƒï¼Œè¯´å¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜ï¼Œæˆ‘å¯»æ€ç½‘ç»œèƒ½æœ‰å•¥é—®é¢˜ï¼Œæˆ‘pingé›†ç¾¤pingç™¾åº¦éƒ½æ²¡é—®é¢˜ã€‚ã€‚ã€‚ã€‚</p>
<p>ã€‚ã€‚ã€‚ã€‚</p>
<p>ã€‚ã€‚ã€‚ã€‚</p>
<p>å§æ§½ï¼Œæˆ‘ä¹‹å‰åˆå§‹åŒ–é¡¹ç›®çš„æ—¶å€™æ˜¯ä¸æ˜¯éƒ½æ²¡å¼€VPNï¼Ÿ</p>
<p>æˆ‘è¯•ç€æ‰“å¼€VPNï¼Œé‡æ–°æ•²å…¥é‚£å¥ä»Šå¤©å·²ç»æ•²äº†100éçš„å‘½ä»¤<code>kubebuilder init XXXX</code>,å®ƒç«Ÿç„¶å¼€å§‹æ˜¾ç¤ºåœ¨githubä¸Šä¸‹è½½goçš„ä»€ä¹ˆä»€ä¹ˆä¸œè¥¿ï¼Œä¸€é•¿ä¸²å æ»¡äº†å±å¹•ã€‚ã€‚ã€‚æ­¤æ—¶æˆ‘å·²å‘†ä½ã€‚</p>
<p>é—®é¢˜è§£å†³ã€‚</p>
<p>(ä¹‹å‰ä¸€ç›´è§‰å¾—chatGPTè¢«å¹å¾—è¿‡å¤´äº†ï¼Œäº§ç”Ÿäº†å¾ˆåæ„Ÿçš„æƒ…ç»ªï¼Œè§‰å¾—ä¹Ÿå°±æ˜¯å¤–è¡Œäººæ‰æŠŠå®ƒè§†ä½œç¥æ˜ï¼Œå¹ä¸Šäº†å¤©ã€‚ç°åœ¨æ„Ÿè§‰è¿™ç©æ„è¿˜æ˜¯èƒ½æä¾›ä¸€äº›æ€è·¯çš„)</p>
</blockquote>
</blockquote>
<p><strong>é¡¹ç›®æ–‡ä»¶ç»“æ„åˆ†æ</strong></p>
<p>åˆå§‹åŒ–å®Œä¹‹åæˆ‘çš„é¡¹ç›®ç»“æ„</p>
<p>.<br />
â”œâ”€â”€ config<br />
â”‚   â”œâ”€â”€ default<br />
â”‚   â”‚   â”œâ”€â”€ kustomization.yaml<br />
â”‚   â”‚   â”œâ”€â”€ manager_auth_proxy_patch.yaml<br />
â”‚   â”‚   â””â”€â”€ manager_config_patch.yaml<br />
â”‚   â”œâ”€â”€ manager<br />
â”‚   â”‚   â”œâ”€â”€ controller_manager_config.yaml<br />
â”‚   â”‚   â”œâ”€â”€ kustomization.yaml<br />
â”‚   â”‚   â””â”€â”€ manager.yaml<br />
â”‚   â”œâ”€â”€ prometheus<br />
â”‚   â”‚   â”œâ”€â”€ kustomization.yaml<br />
â”‚   â”‚   â””â”€â”€ monitor.yaml<br />
â”‚   â””â”€â”€ rbac<br />
â”‚       â”œâ”€â”€ auth_proxy_client_clusterrole.yaml<br />
â”‚       â”œâ”€â”€ auth_proxy_role_binding.yaml<br />
â”‚       â”œâ”€â”€ auth_proxy_role.yaml<br />
â”‚       â”œâ”€â”€ auth_proxy_service.yaml<br />
â”‚       â”œâ”€â”€ kustomization.yaml<br />
â”‚       â”œâ”€â”€ leader_election_role_binding.yaml<br />
â”‚       â”œâ”€â”€ leader_election_role.yaml<br />
â”‚       â”œâ”€â”€ role_binding.yaml<br />
â”‚       â””â”€â”€ service_account.yaml<br />
â”œâ”€â”€ Dockerfile<br />
â”œâ”€â”€ go.mod<br />
â”œâ”€â”€ go.sum<br />
â”œâ”€â”€ hack<br />
â”‚   â””â”€â”€ boilerplate.go.txt<br />
â”œâ”€â”€ main.go<br />
â”œâ”€â”€ Makefile<br />
â”œâ”€â”€ PROJECT<br />
â””â”€â”€ <a target="_blank" rel="noopener" href="http://README.md">README.md</a></p>
<p>å¤§è‡´çœ‹ä¸€ä¸‹å…¶ä¸­çš„å‡ ä¸ªæ–‡ä»¶</p>
<ul>
<li>PROJECTï¼šè®°å½•å…ƒæ•°æ®</li>
<li>main.goï¼šé‡è¦çš„æ–‡ä»¶ï¼Œæ­¤å¤„å…ˆä¸åšåˆ†æã€‚æ³¨æ„åˆ°æ–‡ä»¶å¤´æœ‰copyrightä¿¡æ¯ï¼Œè¿™ä¸ªä¿¡æ¯æ¥è‡ªhack/boilerplate.go.txtæ–‡ä»¶ã€‚</li>
<li>configï¼šè¿™ä¸ªç›®å½•ä¸­æ”¾ç½®äº†å¾ˆå¤šä¸ªYAMLæ–‡ä»¶ã€‚å…¶ä¸­åŒ…æ‹¬RBACæƒé™ç›¸å…³çš„YAMLæ–‡ä»¶ã€Prometheusç›‘æ§æœåŠ¡å‘ç°ï¼ˆServiceMonitorï¼‰ç›¸å…³çš„YAMLæ–‡ä»¶ã€æ§åˆ¶å™¨ï¼ˆManagerï¼‰æœ¬èº«éƒ¨ç½²çš„YAMLæ–‡ä»¶ç­‰ã€‚</li>
<li>Dockerfileï¼šæœ€ç»ˆOperatorç¨‹åºç¼–è¯‘ã€æ„å»ºé•œåƒçš„é€»è¾‘å°±åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿®æ”¹è¿™ä¸ªæ–‡ä»¶æ¥è§£å†³ä¸€äº›é•œåƒæ„å»ºç›¸å…³çš„é—®é¢˜ï¼Œæ¯”å¦‚Goè¯­è¨€ä¾èµ–ä¸‹è½½çš„é»˜è®¤GOPROXYé…ç½®åœ¨å›½å†…ä¸ä¸€å®šèƒ½è®¿é—®åˆ°ï¼Œå¯ä»¥åœ¨å…¶ä¸­é…ç½®å›½å†…çš„proxyåœ°å€ç­‰ã€‚</li>
<li>Makefileï¼šè¿™æ˜¯è§£æ”¾åŠ³åŠ¨åŠ›çš„å·¥å…·ï¼Œè¿™é‡Œå®ç°äº†é€šè¿‡make Ã—Ã—Ã—è½»æ¾å®ç°æ•´ä¸ªç¨‹åºçš„ç¼–è¯‘æ„å»ºã€é•œåƒæ¨é€ã€éƒ¨ç½²ã€å¸è½½ç­‰æ“ä½œï¼Œåé¢ä¼šç»å¸¸ç”¨åˆ°ã€‚</li>
</ul>
<h3 id="3-æ·»åŠ api"><a class="markdownIt-Anchor" href="#3-æ·»åŠ api"></a> 3. æ·»åŠ API</h3>
<p>åœ¨application-operatorç›®å½•ä¸‹ç»§ç»­æ‰§è¡Œå‘½ä»¤ï¼Œè¿ç»­è¾“å…¥ä¸¤æ¬¡yï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubebuilder create api --group apps --version v1 --kind Application</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@master application-operator]# kubebuilder create api --group apps --version v1 --kind Application</span><br><span class="line">Create Resource [y/n]</span><br><span class="line">y</span><br><span class="line">Create Controller [y/n]</span><br><span class="line">y</span><br><span class="line">Writing kustomize manifests for you to edit...</span><br><span class="line">Writing scaffold for you to edit...</span><br><span class="line">api/v1/application_types.go</span><br><span class="line">controllers/application_controller.go</span><br><span class="line">Update dependencies:</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">go mod tidy</span></span><br><span class="line">go: downloading github.com/onsi/ginkgo/v2 v2.0.0</span><br><span class="line">Running make:</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make generate</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>æ–°å¢äº†å¾ˆå¤šæ–‡ä»¶å¤¹å’Œæ–‡ä»¶ï¼Œå°¤å…¶æ˜¯apiæ–‡ä»¶å¤¹æ¯”è¾ƒé‡è¦ï¼›éƒ¨åˆ†æ–‡ä»¶æœ‰æ”¹åŠ¨ï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡git statusè§‚å¯Ÿåˆ°ã€‚</p>
<h3 id="4-crdå®ç°å’Œéƒ¨ç½²"><a class="markdownIt-Anchor" href="#4-crdå®ç°å’Œéƒ¨ç½²"></a> 4. CRDå®ç°å’Œéƒ¨ç½²</h3>
<p>æˆ‘ä»¬å‰é¢æåˆ°è¿‡CRDçš„ä»£ç ä¸»è¦å®šä¹‰åœ¨<strong>api/v1/application_types.go</strong>æ–‡ä»¶ä¸­ï¼Œå…ˆæ‰“å¼€çœ‹ä¸€ä¸‹ç°æœ‰ä»£ç æ˜¯æ€æ ·çš„ã€‚ä¸»è¦çœ‹Specç»“æ„ï¼Œä¹Ÿå°±æ˜¯ApplicationSpecè¿™ä¸ªç»“æ„ä½“çš„å®šä¹‰ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ApplicationSpec <span class="keyword">struct</span> &#123;</span><br><span class="line">	Foo <span class="type">string</span> <span class="string">`json:&quot;foo,omitempty&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¢åŠ å†…å®¹å¦‚ä¸‹</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	corev1 <span class="string">&quot;k8s.io/api/core/v1&quot;</span></span><br><span class="line">	metav1 <span class="string">&quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// EDIT THIS FILE!  THIS IS SCAFFOLDING FOR YOU TO OWN!</span></span><br><span class="line"><span class="comment">// <span class="doctag">NOTE:</span> json tags are required.  Any new fields you add must have json tags for the fields to be serialized.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ApplicationSpec defines the desired state of Application</span></span><br><span class="line"><span class="keyword">type</span> ApplicationSpec <span class="keyword">struct</span> &#123;</span><br><span class="line">	Replicas <span class="type">int32</span>                  <span class="string">`json:&quot;replicas,omitempty&quot;`</span></span><br><span class="line">	Template corev1.PodTemplateSpec <span class="string">`json:&quot;template,omitempty&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ç„¶åä¿å­˜è°ƒç”¨å‘½ä»¤<code>make manifests</code>ï¼Œæ˜¾ç¤ºå¦‚ä¸‹</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/root/MyOPeratorProjects/application-operator/bin/controller-gen rbac:roleName=manager-role crd webhook paths=&quot;./...&quot; output:crd:artifacts:config=config/crd/bases</span><br></pre></td></tr></table></figure>
<p>çœ‹ä¸€ä¸‹è¿™ä¸¤ä¸ªæ–‡ä»¶/ç›®å½•ï¼š</p>
<ol>
<li><strong>Â·config/crd/bases/ï¼š<strong>è¿™ä¸ªç›®å½•ä¸­æ–°å¢äº†ä¸€ä¸ª</strong>apps.danielhu.cn_applications.yaml</strong>æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯Applicationç±»å‹çš„CRDé…ç½®ï¼š</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">controller-gen.kubebuilder.io/version:</span> <span class="string">v0.9.2</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">applications.apps.danielhu.cn</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">apps.danielhu.cn</span></span><br><span class="line">  <span class="attr">names:</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Application</span></span><br><span class="line">    <span class="attr">listKind:</span> <span class="string">ApplicationList</span></span><br><span class="line">    <span class="attr">plural:</span> <span class="string">applications</span></span><br><span class="line">    <span class="attr">singular:</span> <span class="string">application</span></span><br><span class="line">  <span class="attr">scope:</span> <span class="string">Namespaced</span></span><br><span class="line">  <span class="attr">versions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li><strong>Â·config/rbac/role.yaml</strong>ï¼šè¿™é‡Œé¢å®šä¹‰çš„æ˜¯ä¸€ä¸ªClusterRoleï¼Œä»åå­—manager-roleä¸Šå¤§è‡´å¯ä»¥çŒœåˆ°ï¼Œè¿™æ˜¯åé¢Controlleréƒ¨ç½²åå°†å……å½“çš„â€œè§’è‰²â€ã€‚è¯¥æ–‡ä»¶å®šä¹‰äº†å¯¹applicationsèµ„æºçš„åˆ›å»ºã€åˆ é™¤ã€æŸ¥è¯¢ã€æ›´æ–°ç­‰æ“ä½œã€‚</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">manager-role</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">apps.danielhu.cn</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">applications</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">delete</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">patch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">apps.danielhu.cn</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">applications/finalizers</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">apps.danielhu.cn</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">applications/status</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">patch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">update</span></span><br></pre></td></tr></table></figure>
<p>é€šè¿‡<code>make install</code>å‘½ä»¤æ¥å®ŒæˆCRDçš„éƒ¨ç½²è¿‡ç¨‹ï¼š</p>
<p><strong>æŠ¥é”™</strong></p>
<blockquote>
<p>The connection to the server 192.168.62.128:6443 was refused - did you specify the right host or port?<br />
make: *** [install] é”™è¯¯ 1</p>
<p>æ­¤æ—¶çªç„¶å‘ç°K8sé›†ç¾¤ä¸ç®¡ç”¨äº†ï¼ˆä¸ªäººç‰¹å¼‚æ€§åŸå› ï¼‰ï¼è§£å†³é—®é¢˜çš„è¿‡ç¨‹è§â€é›†ç¾¤å‡ºé—®é¢˜â€œæ–‡ç« ã€‚</p>
</blockquote>
<p>æˆåŠŸåè¾“å‡ºä»¥ä¸‹å†…å®¹</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@master application-operator]# make install</span><br><span class="line">test -s /root/MyOPeratorProjects/application-operator/bin/controller-gen || GOBIN=/root/MyOPeratorProjects/application-operator/bin go install sigs.k8s.io/controller-tools/cmd/controller-gen@v0.9.2</span><br><span class="line">/root/MyOPeratorProjects/application-operator/bin/controller-gen rbac:roleName=manager-role crd webhook paths=&quot;./...&quot; output:crd:artifacts:config=config/crd/bases</span><br><span class="line">/root/MyOPeratorProjects/application-operator/bin/kustomize build config/crd | kubectl apply -f -                                                     </span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/applications.apps.danielhu.cn created    </span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œå®Œmake installåï¼ŒCRDå°±éƒ¨ç½²åˆ°é›†ç¾¤ä¸­äº†ï¼Œè¿™æ—¶å¯ä»¥é€šè¿‡kubectlæŸ¥è¯¢åˆšæ‰åˆ›å»ºçš„CRDã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master application-operator]# kubectl get crd                        </span><br><span class="line">NAME                            CREATED AT                                 </span><br><span class="line">applications.apps.danielhu.cn   2023-04-26T06:31:35Z      </span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œapplications.apps.danielhu.cnè¿™ä¸ªCRDå·²ç»å­˜åœ¨äº†ã€‚è¿™æ—¶å°±åƒæŸ¥è¯¢Deploymentæ—¶å¯ä»¥ç”¨kubectl get deploymentä¸€æ ·ï¼Œå¯ä»¥é€šè¿‡kubectl get applicationæ¥æŸ¥è¯¢åˆšæ‰è‡ªå®šä¹‰çš„èµ„æºã€‚è¿™é‡Œçš„æŠ¥é”™ä¿¡æ¯æ˜¯æ²¡æ‰¾åˆ°èµ„æºï¼Œè€Œä¸æ˜¯â€œerror:the server doesnâ€™t have a resource type&quot;application&quot;â€ã€‚æ¢è¨€ä¹‹ï¼Œæ­¤æ—¶kube-apiserverå·²ç»èƒ½è¯†åˆ«è¿™ç§èµ„æºäº†ã€‚</p>
<p><strong>å›é¡¾ä¸€ä¸‹ï¼Œæˆ‘ä»¬ä¾æ¬¡åšçš„äº‹æƒ…ï¼š</strong></p>
<ul>
<li>kubebuilder create api --group xxx --version v1 --king Application
<ul>
<li>è¿™æ—¶å€™åœ¨æç¤ºä¸‹åˆ›å»ºäº†èµ„æºå’Œcontroller</li>
<li>åˆ›å»ºäº†apiæ–‡ä»¶å¤¹ä»¥åŠå˜æ›´äº†main.goç­‰</li>
</ul>
</li>
<li>api/v1/application_types.goæ–‡ä»¶ä¸­importé‡ŒåŠ äº†corev1ï¼Œmetav1ï¼ŒApplicationSpectä¸­åŠ äº†replicaå’Œtemplateå£°æ˜å‰¯æœ¬çš„æ•°é‡å’Œæ¨¡æ¿çš„é…ç½®</li>
<li>make manifestså‘½ä»¤ç”ŸæˆCRï¼ˆconfig/rbac/role.yamlï¼ŒControlleréƒ¨ç½²åå°†å……å½“çš„â€œè§’è‰²â€ã€‚ï¼‰å’ŒCRDé…ç½®ï¼ˆconfig/crd/bases/apps.danielhu.cn_applications.yamlï¼‰ã€‚</li>
<li>é€šè¿‡make installå‘½ä»¤æ¥å®ŒæˆCRDçš„éƒ¨ç½²è¿‡ç¨‹ã€‚
<ul>
<li>å¯ä»¥getåˆ°crdäº†ï¼Œè¿™é‡Œcrdå°±åƒæ˜¯development</li>
</ul>
</li>
</ul>
<h3 id="5-créƒ¨ç½²"><a class="markdownIt-Anchor" href="#5-créƒ¨ç½²"></a> 5. CRéƒ¨ç½²</h3>
<p>å’Œå†™ä¸€ä¸ªDeploymentèµ„æºé…ç½®å¯¹åº”çš„Ã—Ã—Ã—.yamlä¸€æ ·ï¼Œåˆ›å»ºApplicationåŒæ ·éœ€è¦ä¸€ä¸ªYAMLæ–‡ä»¶ã€‚æˆ‘ä»¬åœ¨å‰é¢æåˆ°è¿‡åœ¨config/samplesä¸‹æœ‰ä¸€ä¸ªapps_v1_application.yamlï¼Œå…¶ä¸­å·²ç»æœ‰ä¸€äº›é»˜è®¤é…ç½®é¡¹äº†ï¼Œæˆ‘ä»¬ç¨å¾®ä¿®æ”¹ä¸€ä¸‹ï¼ŒåŠ ä¸Šè‡ªå®šä¹‰çš„å±æ€§ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps.danielhu.cn/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Application</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">application-sample</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx:1.14.2</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="comment"># TODO(user): Add fields here</span></span><br></pre></td></tr></table></figure>
<p>applyä¸€ä¸‹</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master application-operator]# kubectl apply -f config/samples/apps_v1</span><br><span class="line">application.apps.danielhu.cn/application-sample cr</span><br></pre></td></tr></table></figure>
<p>æŸ¥çœ‹åˆšæ‰åˆ›å»ºçš„application</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master application-operator]# kubectl get application</span><br><span class="line">NAME                 AGE</span><br><span class="line">application-sample   99s</span><br></pre></td></tr></table></figure>
<p>ä¸€ä¸ªApplicationç±»å‹çš„application-sampleå®ä¾‹åˆ›å»ºå‡ºæ¥äº†ï¼Œå…¶ä¸­åŒ…å«è‡ªå®šä¹‰çš„æ‰€æœ‰å­—æ®µã€‚ä½†æ˜¯è¿™æ—¶å¹¶ä¸ä¼šæœ‰Podè¢«è‡ªåŠ¨åˆ›å»ºå‡ºæ¥ï¼Œå› ä¸ºè¿˜æ²¡æœ‰å®ç°ç›¸åº”çš„æ§åˆ¶å™¨é€»è¾‘ã€‚</p>
<h3 id="6-controllerå®ç°"><a class="markdownIt-Anchor" href="#6-controllerå®ç°"></a> 6. Controllerå®ç°</h3>
<p>ç°åœ¨å·²ç»æœ‰äº†CRï¼Œè¯¥å®ç°Controlleré€»è¾‘å»åˆ›å»ºPodäº†ã€‚åœ¨controllers/application_controller.goä¸­çš„Reconcile()æ–¹æ³•å†…æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *ApplicationReconciler)</span></span> Reconcile(ctx context.Context, req ctrl.Request) (ctrl.Result, <span class="type">error</span>) &#123;</span><br><span class="line">	l := log.FromContext(ctx)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// get the Application</span></span><br><span class="line">	app := &amp;dappsv1.Application&#123;&#125;</span><br><span class="line">	<span class="keyword">if</span> err := r.Get(ctx, req.NamespacedName, app); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> errors.IsNotFound(err) &#123;</span><br><span class="line">			l.Info(<span class="string">&quot;the Application is not found&quot;</span>)</span><br><span class="line">			<span class="keyword">return</span> ctrl.Result&#123;&#125;, <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">		l.Error(err, <span class="string">&quot;failed to get the Application&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> ctrl.Result&#123;RequeueAfter: <span class="number">1</span> * time.Minute&#125;, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// create pods</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="type">int</span>(app.Spec.Replicas); i++ &#123;</span><br><span class="line">		pod := &amp;corev1.Pod&#123;</span><br><span class="line">			ObjectMeta: metav1.ObjectMeta&#123;</span><br><span class="line">				Name:      fmt.Sprintf(<span class="string">&quot;%s-%d&quot;</span>, app.Name, i),</span><br><span class="line">				Namespace: app.Namespace,</span><br><span class="line">				Labels:    app.Labels,</span><br><span class="line">			&#125;,</span><br><span class="line">			Spec: app.Spec.Template.Spec,</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> err := r.Create(ctx, pod); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			l.Error(err, <span class="string">&quot;failed to create Pod&quot;</span>)</span><br><span class="line">			<span class="keyword">return</span> ctrl.Result&#123;RequeueAfter: <span class="number">1</span> * time.Minute&#125;, err</span><br><span class="line">		&#125;</span><br><span class="line">		l.Info(fmt.Sprintf(<span class="string">&quot;the Pod (%s) has created&quot;</span>, pod.Name))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	l.Info(<span class="string">&quot;all pods has created&quot;</span>)</span><br><span class="line">	<span class="keyword">return</span> ctrl.Result&#123;&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>importéƒ¨åˆ†</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">	corev1 <span class="string">&quot;k8s.io/api/core/v1&quot;</span></span><br><span class="line">	<span class="string">&quot;k8s.io/apimachinery/pkg/api/errors&quot;</span></span><br><span class="line">	metav1 <span class="string">&quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;</span></span><br><span class="line">	<span class="string">&quot;k8s.io/apimachinery/pkg/runtime&quot;</span></span><br><span class="line">	ctrl <span class="string">&quot;sigs.k8s.io/controller-runtime&quot;</span></span><br><span class="line">	<span class="string">&quot;sigs.k8s.io/controller-runtime/pkg/client&quot;</span></span><br><span class="line">	<span class="string">&quot;sigs.k8s.io/controller-runtime/pkg/log&quot;</span></span><br><span class="line">	</span><br><span class="line">	dappsv1 <span class="string">&quot;github.com/daniel-hutao/application-operator/api/v1&quot;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæˆ‘ä»¬æŠŠè‡ªå·±çš„api/v1æ‰“åŒ…å¹¶ä½¿ç”¨åˆ«ådappsv1ï¼Œ<a target="_blank" rel="noopener" href="http://xn--k8s-9s1el2m457i.io/api/apps/v1%E5%8C%85%E4%BA%A7%E7%94%9F%E6%B7%B7%E6%B7%86%E3%80%82">é¿å…å’Œk8s.io/api/apps/v1åŒ…äº§ç”Ÿæ··æ·†ã€‚</a></p>
<p>ä»£ç è§£é‡Šï¼š</p>
<p><img src="../images/go_explain.png" alt="go_explain" /></p>
<p>å¯åŠ¨controllerï¼šæ‰§è¡Œmake run</p>
<p><strong>æŠ¥é”™</strong></p>
<blockquote>
<p>æ­¤æ—¶ä¸å‡ºæ„å¤–çš„åˆå‡ºé—®é¢˜äº†ï¼Œè¾“å‡ºä¸€æ®µæ•°æ®åé¡µé¢åœæ­¢ä¸åŠ¨äº†ï¼Œè¿™æ—¶å€™ctrl+cé€€å‡ºï¼Œæ˜¾ç¤º</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1.682495037273707e+09   INFO    All workers finished    &#123;&quot;controller&quot;: &quot;application&quot;, &quot;controllerGroup&quot;: &quot;apps.danielhu.cn&quot;, &quot;controllerKind&quot;: &quot;Application&quot;&#125;</span><br><span class="line">1.6824950372737312e+09  INFO    Stopping and waiting for caches</span><br><span class="line">1.6824950372738228e+09  INFO    Stopping and waiting for webhooks</span><br><span class="line">1.6824950372738297e+09  INFO    Wait completed, proceeding to shutdown the manager</span><br><span class="line">make: *** [run] é”™è¯¯ 1</span><br></pre></td></tr></table></figure>
<p>ä¸çŸ¥é“ä¸ºå•¥ï¼ŒæŸ¥çœ‹podä¿¡æ¯ï¼Œå‘ç°ä¸‰ä¸ªpodéƒ½åœ¨pending</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@master application-operator]# kubectl get pod</span><br><span class="line">NAME                   READY   STATUS    RESTARTS   AGE</span><br><span class="line">application-sample-0   0/1     Pending   0          7m44s</span><br><span class="line">application-sample-1   0/1     Pending   0          7m44s</span><br><span class="line">application-sample-2   0/1     Pending   0          7m44s</span><br></pre></td></tr></table></figure>
<p>è¿™æ—¶å€™è‚¯å®šæ˜¯describe podï¼Œè¾“å‡ºæœ€åçš„ä¿¡æ¯å¦‚ä¸‹</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Events:</span><br><span class="line">  Type     Reason            Age                  From               Message</span><br><span class="line">  ----     ------            ----                 ----               -------</span><br><span class="line">  Warning  FailedScheduling  65s (x6 over 8m33s)  default-scheduler  0/3 nodes are available: 3 node(s) had taints that the pod didn&#x27;t tolerate.</span><br></pre></td></tr></table></figure>
<p>è¯´ä¸‰ä¸ªèŠ‚ç‚¹éƒ½æœ‰æ±¡ç‚¹ï¼Œmasterè‚¯å®šæ˜¯æœ‰æ±¡ç‚¹çš„ï¼Œå¦å¤–ä¸¤ä¸ªæ€ä¹ˆå›äº‹ï¼ŸæŸ¥çœ‹nodeï¼Œå‘ç°</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@master application-operator]# kubectl get nodes</span><br><span class="line">NAME     STATUS     ROLES    AGE     VERSION</span><br><span class="line">master   Ready      master   5d16h   v1.17.4</span><br><span class="line">node1    NotReady   &lt;none&gt;   5d15h   v1.17.4</span><br><span class="line">node2    NotReady   &lt;none&gt;   5d15h   v1.17.4</span><br></pre></td></tr></table></figure>
<p>ä¸¤ä¸ªèŠ‚ç‚¹ç«Ÿç„¶æ²¡è·‘èµ·æ¥ï¼Ÿdescribe node1å‘ç°æç¤ºNetworkUnavailable</p>
<p>ping Node1å‘ç°ä¸å¯è¾¾</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master application-operator]# ping node1</span><br><span class="line">PING node1 (192.168.62.134) 56(84) bytes of data.</span><br><span class="line">From master (192.168.62.128) icmp_seq=10 Destination Host Unreachable</span><br></pre></td></tr></table></figure>
<p>ä¸çŸ¥é“ä¸ºå•¥ç½‘æ–­äº†node1å¤±å»äº†ipåœ°å€ï¼Œæˆ‘è¿›å…¥node1é‡å¯ç½‘è·¯æœåŠ¡ï¼Œç½‘ç»œå¥½äº†ã€‚</p>
</blockquote>
<p><strong>æŠ¥é”™ï¼š</strong></p>
<blockquote>
<p>1.6824959595997632e+09  ERROR   setup   unable to start manager {â€œerrorâ€: â€œerror listening on :8080: listen tcp :8080: bind: address already in useâ€}</p>
<p>å› ä¸ºè¿™ä¸ªç«¯å£å·²ç»è¢«æˆ‘åˆ›å»ºå‡ºæ¥çš„podå äº†ï¼Œä¸ç”¨å†åˆ›å»ºæ–°çš„äº†ã€‚</p>
</blockquote>
<p>æ­¤æ—¶kubectl get podså¯ä»¥æŸ¥å‡ºä¸‰ä¸ªä¹‹å‰éƒ¨ç½²çš„podå·²ç»åœ¨è¿è¡Œäº†ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# kubectl get pods</span><br><span class="line">NAME                   READY   STATUS    RESTARTS   AGE</span><br><span class="line">application-sample-0   1/1     Running   0          22h</span><br><span class="line">application-sample-1   1/1     Running   0          22h</span><br><span class="line">application-sample-2   1/1     Running   0          22h</span><br></pre></td></tr></table></figure>
<h3 id="7-controlleréƒ¨ç½²"><a class="markdownIt-Anchor" href="#7-controlleréƒ¨ç½²"></a> 7. Controlleréƒ¨ç½²</h3>
<p>å‰é¢æˆ‘ä»¬éƒ¨ç½²äº†ä¸€ä¸ªApplicationç±»å‹çš„èµ„æºå¯¹è±¡å®ä¾‹ï¼Œä¹Ÿè¿è¡ŒControllerçœ‹åˆ°äº†ç›¸åº”å‰¯æœ¬æ•°çš„Podè¢«åˆ›å»ºå‡ºæ¥ã€‚ç°åœ¨æˆ‘ä»¬è¿›ä¸€æ­¥æ¨¡æ‹ŸOperatorå®é™…ä½¿ç”¨æ—¶çš„éƒ¨ç½²æ–¹å¼ï¼ŒæŠŠControlleræ‰“åŒ…åç”¨å®¹å™¨åŒ–æ–¹å¼éƒ¨ç½²åˆ°Kubernetesé›†ç¾¤ç¯å¢ƒä¸­ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">make docker-build IMG=application-operator:v0.0.1</span><br><span class="line">kind load docker-image application-operator:v0.0.1 --name dev    no</span><br><span class="line">make deploy IMG=application-operator:v0.0.1 </span><br></pre></td></tr></table></figure>
<p>å› ä¸ºæˆ‘çš„K8sä¸æ˜¯ä½¿ç”¨kindï¼Œæ‰€ä»¥çœæ‰äº†ç¬¬äºŒæ­¥ï¼Œæœ€ç»ˆæŸ¥åˆ°äº†éƒ¨ç½²çš„Pod</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master application-operator]# kubectl get pod -n application-operator-system</span><br><span class="line">NAME                                                       READY   STATUS         RESTARTS   AGE</span><br><span class="line">application-operator-controller-manager-5b754fc8bd-z28z9   1/2     ErrImagePull   0          2m46s</span><br></pre></td></tr></table></figure>
<p>è‡³æ­¤ï¼Œå°±å®ç°äº†ä¸€ä¸ªéå¸¸ç®€å•çš„Operatorç¨‹åºçš„å¼€å‘ã€ç¼–è¯‘æ„å»ºã€æ‰“åŒ…ã€éƒ¨ç½²ç­‰æµç¨‹ã€‚å½“ç„¶ï¼Œå¦‚æœå‰é¢æ‰§è¡Œmake runå¯åŠ¨äº†æ§åˆ¶å™¨åˆ›å»ºå‡ºæ¥çš„3ä¸ªPodæ²¡æœ‰è¢«åˆ é™¤ï¼Œè¿™æ—¶å†æ¬¡éƒ¨ç½²ä¸€ä¸ªOperatoræ§åˆ¶å™¨ï¼Œæ—¥å¿—é‡Œè‚¯å®šä¼šæœ‰æŠ¥é”™ä¿¡æ¯çš„ï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰å®ç°Podå­˜åœ¨æ ¡éªŒç­‰ä»£ç é€»è¾‘ã€‚ä¸è¿‡è¿™ä¸æ˜¯é‡ç‚¹ï¼Œæœ‰æ²¡æœ‰è¿™äº›é”™è¯¯ï¼Œæˆ‘ä»¬çš„Demoç¨‹åºéƒ½ç®—èµ°å®Œäº†ã€‚åˆ°è¿™é‡Œï¼Œå¤§å®¶åŸºæœ¬ä½“éªŒäº†ä¸€éOperatorçš„å¿«é€Ÿå¼€å‘æµç¨‹ã€‚</p>
<h3 id="8-èµ„æºæ¸…ç†"><a class="markdownIt-Anchor" href="#8-èµ„æºæ¸…ç†"></a> 8. èµ„æºæ¸…ç†</h3>
<p>å‰é¢æˆ‘ä»¬é€šè¿‡å‡ ä¸ªæ­¥éª¤åˆ†åˆ«éƒ¨ç½²äº†CRDã€CRå’ŒControllerï¼Œè¿™æ—¶ç¯å¢ƒä¸­æ–°å¢çš„èµ„æºä¸å°‘ï¼ˆå„ç§rbacç›¸å…³çš„ã€éƒ¨ç½²ç›¸å…³çš„èµ„æºï¼‰ï¼Œå¦‚æœè¿™äº›èµ„æºéƒ½ç”¨kubectlä¸€ä¸ªä¸€ä¸ªæ¥æ¸…ç†ï¼Œè¿˜æ˜¯å¾ˆç—›è‹¦çš„ã€‚åŒæ ·ï¼Œæ¸…ç†çš„æ­¥éª¤ä¹Ÿå¯ä»¥é€šè¿‡Makefileæ¥å®ç°ï¼š</p>
<p>å¸è½½Controllerï¼š<code>make undeploy</code></p>
<p>å¸è½½CRDï¼š<code>make uninstall</code></p>
<h3 id="9æ€»ç»“ä¸ç†è§£"><a class="markdownIt-Anchor" href="#9æ€»ç»“ä¸ç†è§£"></a> 9.æ€»ç»“ä¸ç†è§£</h3>
<p><img src="../images/summarize_helloworld.png" alt="" /></p>
<h3 id="10-å—é”¤æ„Ÿæ‚Ÿ"><a class="markdownIt-Anchor" href="#10-å—é”¤æ„Ÿæ‚Ÿ"></a> 10. å—é”¤æ„Ÿæ‚Ÿ</h3>
<p>åœ¨åšçš„è¿‡ç¨‹ä¸­ä¸€æ¬¡æ¬¡çš„é‡åˆ°å„ç§é—®é¢˜ï¼Œç¯å¢ƒã€ç½‘ç»œã€ç‰ˆæœ¬åŒ¹é…ã€æ•²é”™å‘½ä»¤æ‰¾åŠå¤©ã€k8sè«åå‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬ã€æ•™ç¨‹æœ‰è¯¯â€¦å„ç§é”™è¯¯ï¼Œæ— ä¸€ä¸è®©æˆ‘å¿ƒå¤´ç„¦ç¼æ”¥ç´§æ‹³å¤´ç«å†’ä¸‰ä¸ˆï¼Œå¿ƒç°æ„å†·ã€‚</p>
<p>ä¸æ–­é‡åˆ°é—®é¢˜ï¼Œä¸æ–­è§£å†³é—®é¢˜ï¼Œè¿™ä¸ªè¿‡ç¨‹å¾ˆç—›è‹¦ï¼Œä½†æ˜¯é—®é¢˜è§£å†³çš„é‚£ä¸€åˆ»å¾ˆæœ‰æˆå°±æ„Ÿã€‚</p>
<p>ç›¸ä¿¡åªè¦ä¸æ”¾å¼ƒï¼Œåœ¨è¢«å„ç§â€œé—®é¢˜â€æ´—ç¤¼çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬çš„èƒ½åŠ›ä¼šè¶Šæ¥è¶Šå¼ºã€‚</p>
<blockquote>
<p>Notesï¼š</p>
<p>ä»¥ä¸Šå†…å®¹å‡ä¸ºä¸ªäººå­¦ä¹ è¿‡ç¨‹ä¸­çš„ç†è§£ï¼Œç†è§£å’Œæ€»ç»“å¯èƒ½æœ‰åå·®ã€‚æ–‡ç« å†…å®¹ä¼šéšç€å­¦ä¹ è¿‡ç¨‹ä¸æ–­ä¿®æ”¹å®Œå–„ã€‚</p>
<p>å¦‚æœä»¥ä¸Šæœ‰é”™è¯¯æ¬¢è¿æŒ‡å‡ºã€‚</p>
<p>æœ¬æ¬¡å®éªŒæ¡ˆä¾‹æ¥è‡ª èƒ¡æ¶› <a target="_blank" rel="noopener" href="https://www.danielhu.cn/categories/">https://www.danielhu.cn/categories/</a></p>
</blockquote>

</div>

<!-- post-guide -->

    <div class="post-guide">
        <div class="item left">
            
              <a href="/2023/04/26/7.%20%E3%80%90%E6%95%85%E9%9A%9C%E3%80%91K8s%E7%BB%84%E4%BB%B6%E7%89%88%E6%9C%AC%E5%87%BA%E9%97%AE%E9%A2%98/">
                  <i class="fa fa-angle-left" aria-hidden="true"></i>
                  ã€æ•…éšœã€‘K8sç»„ä»¶ç‰ˆæœ¬å‡ºé—®é¢˜
              </a>
            
        </div>
        <div class="item right">
            
              <a href="/2023/04/25/5.%20%E4%BB%80%E4%B9%88%E6%98%AFOperator/">
                ä»€ä¹ˆæ˜¯Operator
                <i class="fa fa-angle-right" aria-hidden="true"></i>
              </a>
            
        </div>
    </div>


<!-- comment - giscus -->


<!-- comment - valine -->


<script>
	
	
</script>
	</div>
	<div id="footer">
	<p>
	Â©<span id="footerYear-start"></span>-<span id="footerYear-end"></span>
	<a href="/">John Doe</a> 
	
	
	<br>
	Theme <a href="//github.com/wujun234/hexo-theme-tree" target="_blank">Tree</a>
	by <a href="//github.com/wujun234" target="_blank">WuJun</a>
	Powered by <a href="//hexo.io" target="_blank">Hexo</a>
	</p>
</div>


<script type="text/javascript">
	document.getElementById('footerYear-start').innerHTML = new Date().getFullYear() + '';
</script>

<script type="text/javascript">
	document.getElementById('footerYear-end').innerHTML = new Date().getFullYear() + '';
</script>

	<button id="totop-toggle" class="toggle"><i class="fa fa-angle-double-up" aria-hidden="true"></i></button>
</body>
</html>